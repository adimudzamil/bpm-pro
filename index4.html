<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Passenger Meal & Tier Report - by *2100551*</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∫</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∫</text></svg>">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Combined Reports Styles */
        .multi-list-controls {
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .combined-reports-header {
            page-break-after: always;
            margin-bottom: 30px;
        }

        .combined-list {
            break-inside: avoid;
        }

        .page-break-before {
            page-break-before: always;
        }

        /* Print-specific styles for combined reports */
        @media print {
            .combined-reports-header {
                display: none !important;
            }
            
            .list-header {
                display: none !important;
            }
            
            /* Remove decorative borders from combined list */
            .combined-list {
                border: none !important;
                box-shadow: none !important;
                margin-bottom: 20px !important;
                padding: 0 !important;
                background: transparent !important;
            }
            
            /* Show flight info cleanly */
            .combined-list .flight-info {
                background: transparent !important;
                border: 1px solid #000 !important;
                color: #000 !important;
                margin-bottom: 10px !important;
                padding: 4px !important;
                font-weight: bold;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Hide layout badge */
            .combined-list .list-header > div:last-child {
                display: none !important;
            }
            
            /* Ensure page breaks work properly */
            .page-break-before {
                page-break-before: always !important;
            }
            
            .combined-list {
                border: 1px solid #cbd5e1 !important;
                margin-bottom: 40px !important;
            }
            
            /* Ensure each list starts on a new page */
            .combined-list:not(:first-child) {
                page-break-before: always;
                margin-top: 40px;
            }
            
            .no-print {
                display: none !important;
            }
        }

        /* Button styling for multi-list controls */
        .multi-list-controls button {
            transition: all 0.2s ease;
        }

        .multi-list-controls button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .multi-list-controls button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* Saved list items */
        .saved-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .saved-list-info {
            flex: 1;
        }
        
        .saved-list-actions {
            display: flex;
            gap: 5px;
        }
        
        .remove-list-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .saved-lists-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            background: #f9fafb;
        }

        /* Additional styles for combined reports */
        .flight-info {
            max-width: 100%;
            width: var(--table-width, 100%);
            word-wrap: break-word;
            overflow-wrap: break-word;
            box-sizing: border-box;
        }

        /* Update the combined list flight info styling */
        .combined-list .flight-info {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: #f8fafc !important;
            color: #1e293b !important;
            border: 1px solid #cbd5e1 !important;
            border-left: 3px solid #2563eb !important;
            padding: 8px !important;
            font-family: monospace !important;
            font-size: inherit;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* Ensure combined list elements respect table width */
        .combined-list .stats,
        .combined-list .side-stats,
        .combined-list .zone-header {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Make sure tables in combined reports respect width */
        .combined-list table {
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Style for port/starboard tables in combined reports */
        .combined-list .tables-container {
            width: 100% !important;
            max-width: 100% !important;
        }

        .combined-list .table-wrapper {
            flex: 1;
            max-width: 50% !important;
        }

        /* Ensure proper inheritance for font sizes */
        .output-section[data-font-size] .combined-list .flight-info,
        .output-section[data-font-size] .combined-list table,
        .output-section[data-font-size] .combined-list th,
        .output-section[data-font-size] .combined-list td {
            font-size: inherit !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PASSENGER MEAL & TIER REPORT by *2100551*</h1>
        
        <div class="help-section">
            <div class="help-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="toggleTutorial" onchange="toggleHelp('tutorial')">
                    <span class="toggle-slider"></span>
                </label>
                <label class="help-toggle-label" for="toggleTutorial">
                    <span id="tutorialLabel">Show</span> How to Use This Tool
                </label>
            </div>
            
            <div class="help-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="toggleVersion" onchange="toggleHelp('version')">
                    <span class="toggle-slider"></span>
                </label>
                <label class="help-toggle-label" for="toggleVersion">
                    <span id="versionLabel">Show</span> Version Updates
                </label>
            </div>
            
            <!-- NEW: Download Button -->
            <div class="help-toggle">
                <button class="btn-success btn-small" onclick="downloadPage()">
                    üì≤ Download Offline Version
                </button>
            </div>
        </div>
        <!-- NEW: Dual Chart Toggle -->
        <div class="help-toggle">
            <button class="dual-chart-toggle" onclick="toggleDualChartMode()">
                <span>üîÑ</span>
                <span id="dualChartLabel">Dual Chart Mode</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="dualChartToggle">
                    <span class="toggle-slider"></span>
                </label>
            </button>
        </div>
        
        <!-- NEW: Dual Chart Mode Indicator -->
        <div id="dualChartIndicator" class="dual-chart-indicator">
            <span>üîÑ</span>
            <span><strong>Dual Chart Mode Active:</strong> Generate first chart ‚Üí Clear ‚Üí Paste second manifest ‚Üí Generate second chart</span>
        </div>
        
        <!-- Tutorial Content -->
        <div id="tutorialContent" class="help-content">
            <h3>Quick Start Guide - 4 Simple Steps</h3>
            
            <!-- Quick Platform Summary -->
            <div class="platform-summary">
                <div class="platform-card mini">
                    <h4>üíª PC/Mac</h4>
                    <p>1. Ctrl+A (select all)<br>2. Ctrl+C (copy)<br>3. Ctrl+V (paste here)<br>4. Ctrl+Enter (generate)</p>
                </div>
                
                <div class="platform-card mini">
                    <h4>üì± Android</h4>
                    <p>1. Install XClipper<br>2. Select all<br>3. XCopy<br>4. Paste here</p>
                </div>
                
                <div class="platform-card mini">
                    <h4>üçé iOS</h4>
                    <p>1. Tap & hold FLT NBR<br>2. Drag to select all<br>3. Copy<br>4. Paste here</p>
                </div>
            </div>
            
            <div class="simple-steps">
                <div class="step-simple">
                    <div class="step-icon">üìã</div>
                    <div class="step-text">
                        <strong>Step 1:</strong> Copy entire manifest in BPM from "FLT NBR" to "Showing X entries"
                    </div>
                </div>
                
                <div class="step-simple">
                    <div class="step-icon">üìù</div>
                    <div class="step-text">
                        <strong>Step 2:</strong> Paste into the text box below
                    </div>
                </div>
                
                <div class="step-simple">
                    <div class="step-icon">üöÄ</div>
                    <div class="step-text">
                        <strong>Step 3:</strong> Click "Generate Report" or press Ctrl+Enter. Use advance settings for seat chart and more custom configuration
                    </div>
                </div>
                
                <div class="step-simple">
                    <div class="step-icon">üñ®Ô∏è</div>
                    <div class="step-text">
                        <strong>Step 4:</strong> Click "Print Report" and set margins "Fit to page/minimum/custom" depending on your printer
                    </div>
                </div>
            </div>
            
            <div class="critical-note">
                <strong>üö® Android Users:</strong> You MUST install "XClipper" from Play Store to copy long manifests!
            </div>
            
            <!-- Embedded Full Tutorial -->
            <div class="full-tutorial">
                <h4>üìñ Complete Guide & Troubleshooting</h4>
                <div class="iframe-container">
                    <div id="iframe-loading">
                        <div class="spinner"></div>
                        <p>Loading complete tutorial...</p>
                    </div>
                    <iframe 
                        src="tutorial.html" 
                        id="tutorialIframe"
                        title="Complete Tutorial & Troubleshooting"
                        scrolling="yes"
                        loading="lazy"
                        onload="hideIframeLoading()">
                    </iframe>
                </div>
                
                <div class="iframe-controls">
                    <button onclick="reloadIframe()" class="btn-small btn-info">üîÑ Reload</button>
                    <button onclick="openTutorialInNewTab()" class="btn-small btn-success">üîó Open in New Tab</button>
                </div>
            </div>
        </div>
        
        <!-- Version Content -->
        <div id="versionContent" class="help-content">
            <h3>Version History - Complete Release Notes</h3>
            
            <!-- Embedded Version History -->
            <div class="full-tutorial">
                <h4>üìö Complete Version History</h4>
                <div class="iframe-container">
                    <div id="iframe-loading-version">
                        <div class="spinner"></div>
                        <p>Loading version history...</p>
                    </div>
                    <iframe 
                        src="versions.html" 
                        id="versionIframe"
                        title="Complete Version History"
                        scrolling="yes"
                        loading="lazy"
                        onload="hideVersionIframeLoading()">
                    </iframe>
                </div>
                
                <div class="iframe-controls">
                    <button onclick="reloadVersionIframe()" class="btn-small btn-info">üîÑ Reload</button>
                    <button onclick="openVersionsInNewTab()" class="btn-small btn-success">üîó Open in New Tab</button>
                </div>
            </div>
        </div>
        
        <!-- Input Section -->
        <div class="input-section">
            <div class="paste-hint">üí° Paste manifest ‚Üí Generate (Ctrl+Enter) ‚Üí Print - Fast & Simple!</div>
            <textarea id="manifestInput" placeholder="Paste passenger manifest here..."></textarea>
            <div class="button-group">
                <button class="btn-primary" onclick="generateQuickReport()">Generate Report</button>
                <button class="btn-secondary" onclick="clearAll()">Clear</button>
                <button class="btn-info" id="toggleAdvanced" onclick="toggleSettings()">‚ñº Advanced Settings</button>
                <button class="btn-success" onclick="window.print()">Print Report</button>
            </div>
            
            <!-- Advanced Settings -->
            <div id="advancedSettings" class="advanced-settings">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="settings-header">Advanced Configuration</div>
                    <button class="btn-secondary btn-small" onclick="resetToDefaults()">Reset to Defaults</button>
                </div>
                
                <select id="aircraftType" onchange="onAircraftChange()">
                    <option value="auto">Auto-detect from manifest</option>
                    <optgroup label="Narrowbody (737)">
                        <option value="737NG">737NG: J:1-3, Y:4-31</option>
                        <option value="737MAX">737MAX: J:1-3, Y:4-31</option>
                        <option value="737NR">737NR: J:1-4, Y:5-30</option>
                    </optgroup>
                    <optgroup label="Widebody">
                        <option value="333">A330-300: J:1-7, C:9-27, D:28-44</option>
                        <option value="332">A330-200: J:1-6, C:14-30, D:31-50</option>
                        <option value="339">A330-900: J:1-8, C:9-26, D:27-44</option>
                        <option value="359">A350-900: J:1-11, C:12-22, D:23-32, E:33-41</option>
                        <option value="350">A350-MAH: J:1-10, C:20-35, D:36-46, E:47-55</option>
                    </optgroup>
                    <option value="custom">Custom Configuration</option>
                </select>
                
                <div id="customZones" class="custom-zones">
                    <div class="settings-header">Custom Zone Configuration</div>
                    <div id="zoneError" class="zone-error"></div>
                    <div id="zoneBuilder" class="zone-builder"></div>
                    <button class="btn-info btn-small" onclick="addCustomZone()">+ Add Zone</button>
                    <button class="btn-success btn-small" onclick="updateCustomZones()">Update Zones</button>
                </div>
                
                <div class="settings-header" style="margin-top: 15px;">Layout Style</div>
                <select id="layoutStyle">
                    <option value="auto">Auto (Smart Default)</option>
                    <option value="single">Traditional Single Column</option>
                    <option value="port-starboard">Port/Starboard Split</option>
                    <option value="seat-chart">Seat Chart (Alpha VainGlory)</option>
                    <option value="seat-chart-business">Seat Chart - Business Class</option>
                    <option value="dual-chart-737">Dual Service Chart - 737 Business Class</option>
                </select>
                
                <!-- NEW: Dual Chart Instructions -->
                <div id="dualChartInstructions" class="dual-chart-instructions" style="display: none;">
                    <strong>üìã Dual Chart Instructions:</strong>
                    <ul class="dual-chart-steps">
                        <li>1. Select your 737 aircraft type (NG, MAX, or NR)</li>
                        <li>2. Paste <strong>FIRST SERVICE</strong> manifest and click "Generate Report"</li>
                        <li>3. Popup opens with first service chart. Wait for "Chart ready" message.</li>
                        <li>4. Clear the text box, paste <strong>SECOND SERVICE</strong> manifest</li>
                        <li>5. Click "Generate Report" again - it will send to existing popup</li>
                        <li>6. Print both services on one page!</li>
                    </ul>
                </div>
                
                <div class="settings-header" style="margin-top: 15px;">Font Size</div>
                <div class="font-size-controls">
                    <div class="font-size-selector">
                        <input type="range" id="fontSizeSlider" min="7" max="14" value="9" step="1">
                        <span id="fontSizeDisplay" style="font-weight: 600; color: #2563EB; min-width: 40px;">9px</span>
                    </div>
                    <div class="font-size-presets">
                        <button class="btn-small btn-secondary" onclick="setFontSize(7)">Small (7px)</button>
                        <button class="btn-small btn-info" onclick="setFontSize(9)">Default (9px)</button>
                        <button class="btn-small btn-success" onclick="setFontSize(12)">Large (12px)</button>
                        <button class="btn-small btn-primary" onclick="setFontSize(14)">X-Large (14px)</button>
                    </div>
                </div>
                
                <!-- Table Width & Column Controls -->
                <div class="settings-header">Table Width & Column Layout</div>
                <div class="table-controls">
                    <div class="control-group">
                        <label>Table Width: <span id="tableWidthValue">100%</span></label>
                        <input type="range" id="tableWidthSlider" min="50" max="150" value="100" step="10">
                    </div>
                </div>
                
                <div class="settings-header">Seat Chart Controls</div>
                <div class="table-controls">
                    <div class="control-group">
                        <label>Seat Chart Font Size: <span id="seatChartFontValue">14px</span></label>
                        <input type="range" id="seatChartFontSlider" min="8" max="16" value="14" step="1">
                        <div style="font-size: 10px; color: #64748B; margin-top: 5px;">
                            Line 1: Name/Tier | Line 2: Meal (2px larger for emphasis) | Line 3: Meal/Blank | Line 4: Blank line for writing in business class
                        </div>
                    </div>
                    
                    <!-- Aft Perspective View Option -->
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="flipSeatChart">
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="flipSeatChart">
                            <strong>Aft Perspective View</strong>
                            <span class="option-description">Flip seat chart: rows reversed (3‚Üí1) and columns reversed (A‚ÜíF) - print and turn paper for perfect aft cabin view</span>
                        </label>
                    </div>
                    
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="showAllBusiness">
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="showAllBusiness">
                            <strong>Show All Business Class Passengers in Seat Chart</strong>
                            <span class="option-description">Display all business class passengers (B/J zones), even without special meals/tier. Economy zones continue to show only special cases.</span>
                        </label>
                    </div>
                </div>
                
                <!-- Print Layout Options -->
                <div class="settings-header">Print Layout Options</div>
                <div class="print-layout-controls">
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="compactPrintMode">
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="compactPrintMode">
                            <strong>Compact Print Mode</strong>
                            <span class="option-description">Save 20-30% paper for large lists (100+ pax)</span>
                        </label>
                    </div>
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="landscapeMode">
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="landscapeMode">
                            <strong>Landscape Orientation</strong>
                            <span class="option-description">Best for 12px+ fonts and wide tables</span>
                        </label>
                    </div>
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="pageBreakBetweenZones" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="pageBreakBetweenZones">
                            <strong>Page Break Between Zones</strong>
                            <span class="option-description">Start each zone on a new page when printing</span>
                        </label>
                    </div>
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="avoidOrphanRows" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="avoidOrphanRows">
                            <strong>Avoid Orphan Rows</strong>
                            <span class="option-description">Keep at least 2 rows together when page breaks occur</span>
                        </label>
                    </div>
                    <!-- Show Unassigned Table in Print Option -->
                    <div class="print-option">
                        <label class="toggle-switch">
                            <input type="checkbox" id="showUnassignedInPrint">
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-label" for="showUnassignedInPrint">
                            <strong>Show Unassigned Table in Print View</strong>
                            <span class="option-description">Include unassigned passengers table in printed reports</span>
                        </label>
                    </div>
                    <div style="margin-top: 12px; padding: 10px; background: #EFF6FF; border-radius: 4px; border-left: 3px solid #2563EB; font-size: 11px; color: #1E3A8A;">
                        <strong>üìÑ Estimated Pages:</strong> <span id="pageEstimate">Generate report to see estimate</span>
                    </div>
                </div>
                
                <!-- NEW: Multi-List Save/Combine Controls -->
                <div class="settings-header">Multi-List Combine & Print</div>
                <div class="multi-list-controls">
                    <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-info btn-small" onclick="saveCurrentList()" id="saveListBtn">
                            üíæ Save Current List
                        </button>
                        <button class="btn-secondary btn-small" onclick="clearSavedLists()">
                            üóëÔ∏è Clear All Saved
                        </button>
                        <button class="btn-success btn-small" onclick="combineAndPrintLists()" id="combinePrintBtn">
                            üìÑ Combine & Print (0 saved)
                        </button>
                    </div>
                    
                    <div style="
                        font-size: 10px;
                        color: #64748b;
                        margin-top: 10px;
                        padding: 8px;
                        background: #f0fdf4;
                        border-radius: 4px;
                        border-left: 3px solid #10b981;
                    ">
                        <strong>üí° How to use Multi-List Combine:</strong><br>
                        1. Generate first list (Single Column or Port/Starboard)<br>
                        2. Click "Save Current List"<br>
                        3. Clear, paste second manifest, generate<br>
                        4. Save second list<br>
                        5. Click "Combine & Print" - Each list prints on separate page<br>
                        6. In print dialog, select "Front and Back" for duplex printing
                    </div>
                    
                    <div id="savedListsStatus" style="
                        font-size: 11px;
                        background: #f0f9ff;
                        border: 1px solid #bae6fd;
                        border-radius: 4px;
                        padding: 8px;
                        margin-top: 10px;
                        min-height: 20px;
                    ">
                        No lists saved. Generate and save up to 3 lists to combine.
                    </div>
                    
                    <div id="savedListsPreview" style="display: none; margin-top: 10px;">
                        <strong>Saved Lists Preview:</strong>
                        <div class="saved-lists-container" id="savedListsContent"></div>
                    </div>
                </div>
                
                <div class="settings-header">Display Zones</div>
                <div id="zoneCheckboxes" class="zone-checkboxes"></div>
                
                <button class="btn-success" onclick="window.print()" style="width: 100%; margin-top: 10px;">Print Report with Current Settings</button>
            </div>
        </div>
        
        <!-- Output Section -->
        <div class="output-section" id="reportContent"></div>
        
        <!-- Acknowledgments -->
        <div class="acknowledgments">
            <h2>ACKNOWLEDGMENTS</h2>
            <p style="margin-bottom: 5px; text-align: center;">This tool was made possible thanks to:</p>
            <ul style="margin-left: 20px;">
                <li><strong>Nadiya and Zayn Ikhlas</strong> - for the LOVE</li>
                <li><strong>Alif</strong> - For the initial problem of android copy paste, printing, 6 years of writing for every flight, testing and valuable feedback</li>
                <li><strong>Fahrin</strong> - For the ideas, iOS testing, bugs found and suggestions</li>
                <li><strong>Nurhadi, Nazim, Jessie Lau</strong> - For Android testing</li>
                <li><strong>Amalina</strong> - For iOS testing and tutorial</li>
                <li><strong>Dora</strong> - Teaching me how to open this in PC</li>
                <li><strong>Hafizah</strong> - For the aircraft configurations</li>
                <li><strong>LS Batch 3/25</strong> - For inspiring this project and testing</li>
                <li><a href="https://spck.io/" target="_blank"><strong>SPCK editor</strong></a> - Spck editor for coding and git</li>
                <li><a href="https://kaustubhpatange.github.io/XClipper/" target="_blank"><strong>Xclipper</strong></a> - Must have for android mobile</li>
                <li><a href="https://adimudzamil.github.io/ftl/" target="_blank"><strong>FTL calculator and Roster with FTL timer and info</strong></a> - if you wanna test it out for me, feedback needed</li>
                <li><a href="https://adimudzamil.github.io/roster/" target="_blank"><strong>Roster to Calendar</strong></a> - How i add roster to my calendar and set alarm for every flight</li>
                <li><a href="https://adimudzamil.github.io/log/" target="_blank"><strong>ICC Timestamp Logger</strong></a> - Time stamp logger for ICC, still testing and debugging</li>
            </ul>
            <p style="margin-top: 10px; font-style: italic; text-align: center;">Thank you all for your help during testing and for helping make this tool better for everyone! ‚úàÔ∏è</p>
            
            <div class="version-info">
                Version 4.0 | Multi-List Combine Feature | 4th Line for Business Class Writing | Left-Aligned Empty Seat Numbers | Show Unassigned Table in Print
                <br>Any bugs or feedback please contact Zayn Ikhlas when he is 21. I only do this when i'm babysitting Zayn or n/s lol XP
            </div>
        </div>
    </div>
    
    <script>
        // =================== DUAL CHART GLOBAL VARIABLES ===================
        let seatChartWindow = null;
        let chartReadyForSecondManifest = false;
        let isDualChartMode = false;
        
        // =================== MULTI-LIST SAVE/COMBINE FUNCTIONALITY ===================
        let savedLists = [];
        const MAX_SAVED_LISTS = 3;
        
        // Function to save current list
        function saveCurrentList() {
            // Check if current layout is supported (single or port-starboard only)
            const layoutStyle = document.getElementById('layoutStyle').value;
            const supportedLayouts = ['single', 'port-starboard'];
            
            if (!supportedLayouts.includes(layoutStyle)) {
                showError('Multi-list save is only available for: Traditional Single Column or Port/Starboard Split layouts.');
                return;
            }
            
            const input = document.getElementById('manifestInput').value;
            if (!input.trim()) {
                showError('Please paste passenger manifest data first.');
                return;
            }
            
            try {
                const { flightInfo, passengers } = parseManifest(input);
                const filtered = passengers.filter(p => p.meal || p.tier === 'EMER' || p.tier === 'PLAT');
                
                if (filtered.length === 0 && !currentSettings.showAllBusiness) {
                    showError('No passengers found with special meals or EMER/PLAT tier. Cannot save empty list.');
                    return;
                }
                
                // Create list object
                const listData = {
                    id: Date.now(),
                    flightNumber: flightInfo.flightNumber || 'Unknown',
                    sector: flightInfo.sector || '',
                    date: flightInfo.date || '',
                    time: flightInfo.stdLocal || '',
                    totalPassengers: filtered.length,
                    specialMeals: filtered.filter(p => p.meal).length,
                    emerPlat: filtered.filter(p => p.tier === 'EMER' || p.tier === 'PLAT').length,
                    layout: layoutStyle,
                    aircraftConfig: document.getElementById('aircraftType').value,
                    timestamp: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                    passengers: filtered,
                    flightInfo: flightInfo,
                    settings: { ...currentSettings } // Save current settings
                };
                
                // Check if we've reached maximum
                if (savedLists.length >= MAX_SAVED_LISTS) {
                    savedLists.shift(); // Remove oldest
                }
                
                savedLists.push(listData);
                updateSavedListsUI();
                
                // Store in localStorage for persistence
                localStorage.setItem('savedPassengerLists', JSON.stringify(savedLists));
                
                showSuccess(`List saved! (${savedLists.length}/${MAX_SAVED_LISTS} saved)`);
                
            } catch (error) {
                showError(`Error saving list: ${error.message}`);
            }
        }
        
        // Function to clear all saved lists
        function clearSavedLists() {
            savedLists = [];
            localStorage.removeItem('savedPassengerLists');
            updateSavedListsUI();
            showSuccess('All saved lists cleared.');
        }
        
        // Function to update UI showing saved lists
        function updateSavedListsUI() {
            const statusElement = document.getElementById('savedListsStatus');
            const previewElement = document.getElementById('savedListsPreview');
            const combineBtn = document.getElementById('combinePrintBtn');
            const saveBtn = document.getElementById('saveListBtn');
            
            if (savedLists.length === 0) {
                statusElement.innerHTML = 'No lists saved. Generate and save up to 3 lists to combine.';
                previewElement.style.display = 'none';
                combineBtn.innerHTML = `üìÑ Combine & Print (0 saved)`;
                combineBtn.disabled = true;
                combineBtn.style.opacity = '0.5';
                saveBtn.innerHTML = 'üíæ Save Current List';
                return;
            }
            
            // Update combine button
            combineBtn.innerHTML = `üìÑ Combine & Print (${savedLists.length} saved)`;
            combineBtn.disabled = false;
            combineBtn.style.opacity = '1';
            
            // Update save button with count
            saveBtn.innerHTML = `üíæ Save Current List (${savedLists.length}/${MAX_SAVED_LISTS})`;
            
            // Update status
            let statusText = `<strong>${savedLists.length} list${savedLists.length > 1 ? 's' : ''} saved:</strong><br>`;
            savedLists.forEach((list, index) => {
                const layoutName = list.layout === 'port-starboard' ? 'Port/Starboard' : 'Single Column';
                statusText += `${index + 1}. ${list.flightNumber} (${list.totalPassengers} pax) - ${layoutName} - ${list.timestamp}<br>`;
            });
            statusElement.innerHTML = statusText;
            
            // Show preview
            previewElement.style.display = 'block';
            updateListsPreview();
        }
        
        // Function to generate preview of saved lists
        function updateListsPreview() {
            const previewContent = document.getElementById('savedListsContent');
            let previewHTML = '';
            
            savedLists.forEach((list, index) {
                const mealCount = list.passengers.filter(p => p.meal).length;
                const tierCount = list.passengers.filter(p => p.tier === 'EMER' || p.tier === 'PLAT').length;
                
                previewHTML += `
                    <div class="saved-list-item">
                        <div class="saved-list-info">
                            <strong>List ${index + 1}: ${list.flightNumber}</strong><br>
                            <small>${list.sector} ‚Ä¢ ${list.totalPassengers} pax ‚Ä¢ ${list.timestamp}</small><br>
                            <small>Meals: ${mealCount} ‚Ä¢ EMER/PLAT: ${tierCount}</small>
                        </div>
                        <div class="saved-list-actions">
                            <button onclick="removeSavedList(${list.id})" class="remove-list-btn">
                                Remove
                            </button>
                        </div>
                    </div>
                `;
            });
            
            previewContent.innerHTML = previewHTML;
        }
        
        // Function to remove specific saved list
        function removeSavedList(listId) {
            savedLists = savedLists.filter(list => list.id !== listId);
            localStorage.setItem('savedPassengerLists', JSON.stringify(savedLists));
            updateSavedListsUI();
            showSuccess('List removed.');
        }
        
        // Main function to combine and print lists
        function combineAndPrintLists() {
            if (savedLists.length === 0) {
                showError('No lists saved to combine.');
                return;
            }
            
            try {
                const combinedHTML = generateCombinedReport();
                
                // Display combined report
                document.getElementById('reportContent').innerHTML = combinedHTML;
                
                // Apply current settings for styling
                updateUIFromSettings();
                
                // Show success message with print instructions
                const listCount = savedLists.length;
                const pageCount = listCount; // Each list on its own page
                
                showSuccess(`
                    ‚úÖ Combined ${listCount} list${listCount > 1 ? 's' : ''} successfully!<br>
                    ‚Ä¢ Each list starts on a new page for duplex printing<br>
                    ‚Ä¢ <strong>Print Settings:</strong> Select "Front and Back" or "Duplex" in your printer dialog<br>
                    ‚Ä¢ Estimated pages: ${pageCount} (${listCount} list${listCount > 1 ? 's' : ''})
                `);
                
                // Auto-open print dialog after a short delay
                setTimeout(() => {
                    if (confirm(`Ready to print ${listCount} combined list${listCount > 1 ? 's' : ''}? Click OK to open print dialog.`)) {
                        window.print();
                    }
                }, 500);
                
            } catch (error) {
                showError(`Error combining lists: ${error.message}`);
            }
        }
        
        // Function to generate combined HTML report - FIXED VERSION
        function generateCombinedReport() {
            // Get current table width setting
            const tableWidth = currentSettings.tableWidth;
            
            let combinedHTML = `
                <div class="combined-reports-header" style="
                    text-align: center;
                    margin-bottom: 20px;
                    padding: 15px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border-radius: 8px;
                ">
                    <h2 style="margin: 0 0 10px 0;">COMBINED PASSENGER REPORTS</h2>
                    <div style="font-size: 14px;">
                        ${savedLists.length} List${savedLists.length > 1 ? 's' : ''} ‚Ä¢ Generated: ${new Date().toLocaleString()}
                    </div>
                </div>
            `;
            
            // Generate each saved list
            savedLists.forEach((list, index) => {
                const isLastList = index === savedLists.length - 1;
                
                // Page break for each list except the last one
                const pageBreakClass = !isLastList ? 'page-break-before' : '';
                
                // List header with clear identification
                const listHeader = `
                    <div class="list-header" style="
                        background: #e0f2fe;
                        padding: 10px;
                        border-left: 4px solid #2563eb;
                        margin: 20px 0 15px 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <div>
                            <strong style="font-size: 16px;">LIST ${index + 1} of ${savedLists.length}</strong>
                            <div style="font-size: 12px; color: #374151;">
                                ${list.flightNumber} ‚Ä¢ ${list.sector} ‚Ä¢ ${list.date} ${list.time}
                                ‚Ä¢ ${list.totalPassengers} passenger${list.totalPassengers !== 1 ? 's' : ''}
                            </div>
                        </div>
                        <div style="
                            background: white;
                            padding: 5px 10px;
                            border-radius: 20px;
                            font-size: 12px;
                            color: #2563eb;
                            border: 1px solid #93c5fd;
                        ">
                            ${list.layout === 'port-starboard' ? 'PORT/STARBOARD SPLIT' : 'SINGLE COLUMN'}
                        </div>
                    </div>
                `;
                
                // Generate flight info for this list - FIXED with width
                const flightInfoHTML = `
                    <div class="flight-info" style="
                        width: ${tableWidth}%;
                        margin: 0 auto 15px auto;
                        padding: 8px;
                        background: #f8fafc;
                        border-left: 3px solid #2563eb;
                        font-family: monospace;
                        font-size: ${currentSettings.fontSize}px;
                        box-sizing: border-box;
                    ">
                        <strong>Flight:</strong> ${list.flightInfo.flightNumber || 'Unknown'} | 
                        <strong>Route:</strong> ${list.flightInfo.sector || ''} | 
                        <strong>Date:</strong> ${list.flightInfo.date || ''} ${list.flightInfo.stdLocal || ''} | 
                        <strong>ACFT:</strong> ${list.flightInfo.aircraft || ''}
                    </div>
                `;
                
                // Generate summary for this list
                const mealCount = list.passengers.filter(p => p.meal).length;
                const tierCount = list.passengers.filter(p => p.tier === 'EMER' || p.tier === 'PLAT').length;
                let bbmlCount = 0;
                const mealCounts = {};
                
                list.passengers.forEach(p => {
                    if (p.meal) {
                        const meals = p.meal.split(',').map(m => m.trim());
                        meals.forEach(meal => {
                            if (meal === 'BBML') bbmlCount++;
                            else if (meal) mealCounts[meal] = (mealCounts[meal] || 0) + 1;
                        });
                    }
                });
                
                const mealBreakdown = Object.entries(mealCounts)
                    .sort((a, b) => b[1] - a[1])
                    .map(([meal, count]) => `${meal}: ${count}`)
                    .join(', ');
                
                const summaryHTML = `
                    <div class="stats" style="width: ${tableWidth}%; margin: 0 auto;">
                        <strong>Summary:</strong> 
                        Special Meals: ${mealCount} | 
                        EMER/PLAT: ${tierCount}
                        ${bbmlCount > 0 ? `| Infants (BBML): ${bbmlCount}` : ''}
                        <br>
                        <strong>Meal Breakdown:</strong> ${mealBreakdown || 'None'}
                        ${bbmlCount > 0 ? `| BBML: ${bbmlCount}` : ''}
                    </div>
                `;
                
                // Generate table for this list based on layout
                let tableHTML = '';
                if (list.layout === 'port-starboard') {
                    // Detect if widebody or narrowbody based on seat letters
                    const hasWidebodySeats = list.passengers.some(p => {
                        if (!p.seat) return false;
                        const seatLetter = p.seat.slice(-1).toUpperCase();
                        return ['G', 'H', 'J', 'K'].includes(seatLetter);
                    });
                    
                    if (hasWidebodySeats) {
                        // Widebody port/starboard split
                        const portPax = list.passengers.filter(p => {
                            if (!p.seat) return false;
                            const seatLetter = p.seat.slice(-1).toUpperCase();
                            return ['A', 'B', 'C', 'D', 'E'].includes(seatLetter);
                        });
                        const starboardPax = list.passengers.filter(p => {
                            if (!p.seat) return false;
                            const seatLetter = p.seat.slice(-1).toUpperCase();
                            return ['F', 'G', 'H', 'J', 'K'].includes(seatLetter);
                        });
                        
                        tableHTML = `
                            <div class="tables-container">
                                <div class="table-wrapper" style="width: 48%;">
                                    <div class="table-title">PORT SIDE (ABCDE)</div>
                                    ${generateSideStats(portPax, 'Port')}
                                    ${generateTable(portPax, true, 'widebody')}
                                </div>
                                <div class="table-wrapper" style="width: 48%;">
                                    <div class="table-title">STARBOARD SIDE (FGHJK)</div>
                                    ${generateSideStats(starboardPax, 'Starboard')}
                                    ${generateTable(starboardPax, true, 'widebody')}
                                </div>
                            </div>
                        `;
                    } else {
                        // Narrowbody port/starboard split
                        const portPax = list.passengers.filter(p => {
                            if (!p.seat) return false;
                            const seatLetter = p.seat.slice(-1).toUpperCase();
                            return ['A', 'B', 'C'].includes(seatLetter);
                        });
                        const starboardPax = list.passengers.filter(p => {
                            if (!p.seat) return false;
                            const seatLetter = p.seat.slice(-1).toUpperCase();
                            return ['D', 'E', 'F'].includes(seatLetter);
                        });
                        
                        tableHTML = `
                            <div class="tables-container">
                                <div class="table-wrapper" style="width: 48%;">
                                    <div class="table-title">PORT SIDE (ABC)</div>
                                    ${generateSideStats(portPax, 'Port')}
                                    ${generateTable(portPax, true, 'narrowbody')}
                                </div>
                                <div class="table-wrapper" style="width: 48%;">
                                    <div class="table-title">STARBOARD SIDE (DEF)</div>
                                    ${generateSideStats(starboardPax, 'Starboard')}
                                    ${generateTable(starboardPax, true, 'narrowbody')}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Single column layout
                    // Detect aircraft type for table styling
                    const hasWidebodySeats = list.passengers.some(p => {
                        if (!p.seat) return false;
                        const seatLetter = p.seat.slice(-1).toUpperCase();
                        return ['G', 'H', 'J', 'K'].includes(seatLetter);
                    });
                    
                    const aircraftTypeForTable = hasWidebodySeats ? 'widebody' : 'narrowbody';
                    tableHTML = generateTable(list.passengers, true, aircraftTypeForTable);
                }
                
                // Combine all parts for this list
                combinedHTML += `
                    <div class="combined-list ${pageBreakClass}" style="
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        padding: 20px;
                        margin-bottom: 30px;
                        background: white;
                        position: relative;
                    ">
                        ${listHeader}
                        ${flightInfoHTML}
                        ${summaryHTML}
                        ${tableHTML}
                    </div>
                `;
            });
            
            return combinedHTML;
        }
        
        // Load saved lists from localStorage on page load
        function loadSavedLists() {
            const savedData = localStorage.getItem('savedPassengerLists');
            if (savedData) {
                try {
                    savedLists = JSON.parse(savedData);
                    updateSavedListsUI();
                } catch (error) {
                    console.error('Error loading saved lists:', error);
                    savedLists = [];
                }
            }
        }
        
        // =================== GLOBAL CONFIGURATION ===================
        const CONFIG = {
            SEAT_PATTERN: /^\d{2}[A-K]$/i,
            PNR_PATTERN: /^[A-Z0-9]{6,7}$/i,
            CLASS_PATTERN: /^[JY]$/i,
            TITLES: ['MR', 'MS', 'MRS', 'MISS', 'MSTR', 'DATO', 'DATIN', 'DTUK', 'TSRI', 'MDM', 'DR', 'PROF'],
            TIERS: ['ELIT', 'PLAT', 'GOLD', 'RUBY', 'SLVR', 'BLUE', 'SAPH', 'EMER']
        };
        
        const AIRCRAFT_CONFIGS = {
            '737NG': [{ name: 'B', start: 1, end: 3 }, { name: 'EY', start: 4, end: 31 }],
            '737MAX': [{ name: 'B', start: 1, end: 3 }, { name: 'EY', start: 4, end: 31 }],
            '737NR': [{ name: 'B', start: 1, end: 4 }, { name: 'EY', start: 5, end: 30 }],
            '333': [{ name: 'B', start: 1, end: 7 }, { name: 'C', start: 9, end: 27 }, { name: 'D', start: 28, end: 44 }],
            '332': [{ name: 'B', start: 1, end: 6 }, { name: 'C', start: 14, end: 30 }, { name: 'D', start: 31, end: 50 }],
            '339': [{ name: 'B', start: 1, end: 8 }, { name: 'C', start: 9, end: 26 }, { name: 'D', start: 27, end: 44 }],
            '359': [{ name: 'B', start: 1, end: 11 }, { name: 'C', start: 12, end: 22 }, { name: 'D', start: 23, end: 32 }, { name: 'E', start: 33, end: 41 }],
            '350': [{ name: 'B', start: 1, end: 10 }, { name: 'C', start: 20, end: 35 }, { name: 'D', start: 36, end: 46 }, { name: 'E', start: 47, end: 55 }]
        };
        
        const BUSINESS_CLASS_TEMPLATES = {
            '333': { template: 'sc-a333.html', businessRows: [1, 2, 4, 5, 6, 7] },
            '332': { template: 'sc-a332.html', businessRows: [1, 2, 3, 4, 5, 6] },
            '359': { template: 'sc-a359.html', businessRows: [2, 3, 5, 6, 7, 8, 9, 10, 11] },
            '350': { template: 'sc-a350.html', businessRows: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] },
            '339': { template: 'sc-a339.html', businessRows: [1, 2, 3, 5, 6, 7, 8] },
            '737NG': { template: 'sc-737.html', businessRows: [1, 2, 3] },
            '737MAX': { template: 'sc-737.html', businessRows: [1, 2, 3] },
            '737NR': { template: 'sc-737.html', businessRows: [1, 2, 3, 4] }
        };
        
        const SEAT_MAPS = {
            '737NG': { columns: ['A', 'B', 'C', '|', 'D', 'E', 'F'], aisles: [3] },
            '737MAX': { columns: ['A', 'B', 'C', '|', 'D', 'E', 'F'], aisles: [3] },
            '737NR': { columns: ['A', 'B', 'C', '|', 'D', 'E', 'F'], aisles: [3] },
            '333': { columns: ['A', 'C', '|', 'D', 'E', 'F', 'G', '|', 'H', 'K'], aisles: [2, 7] },
            '332': { columns: ['A', 'C', '|', 'D', 'E', 'F', 'G', '|', 'H', 'K'], aisles: [2, 7] },
            '339': { columns: ['A', 'C', '|', 'D', 'E', 'F', 'G', '|', 'H', 'K'], aisles: [2, 7] },
            '359': { columns: ['A', 'B', 'C', '|', 'D', 'F', 'G', '|', 'H', 'J', 'K'], aisles: [3, 7] },
            '350': { columns: ['A', 'B', 'C', '|', 'D', 'E', 'F', '|', 'G', 'H', 'J'], aisles: [3, 7] }
        };
        
        // Global state
        let currentSettings = {
            aircraftType: 'auto',
            layoutStyle: 'auto',
            fontSize: 9,
            tableWidth: 100,
            seatChartFontSize: 14,
            compactPrint: false,
            landscapeMode: false,
            pageBreakZones: true,
            avoidOrphans: true,
            flipSeatChart: false,
            showAllBusiness: false,
            showUnassignedInPrint: false,
            activeZones: {},
            detectedAircraftType: 'narrowbody'
        };
        
        let customZones = [];
        let debounceTimer;
        let tutorialIframeLoaded = false;
        let versionIframeLoaded = false;
        
        // =================== DUAL CHART FUNCTIONS ===================
        function toggleDualChartMode() {
            const toggle = document.getElementById('dualChartToggle');
            isDualChartMode = !toggle.checked;
            toggle.checked = isDualChartMode;
            
            const label = document.getElementById('dualChartLabel');
            const indicator = document.getElementById('dualChartIndicator');
            
            if (isDualChartMode) {
                label.textContent = 'Dual Chart Mode ON';
                indicator.classList.add('active');
                document.getElementById('layoutStyle').value = 'dual-chart-737';
                showDualChartInstructions();
            } else {
                label.textContent = 'Dual Chart Mode';
                indicator.classList.remove('active');
                hideDualChartInstructions();
            }
        }
        
        function showDualChartInstructions() {
            const instructions = document.getElementById('dualChartInstructions');
            if (instructions) instructions.style.display = 'block';
        }
        
        function hideDualChartInstructions() {
            const instructions = document.getElementById('dualChartInstructions');
            if (instructions) instructions.style.display = 'none';
        }
        
        // =================== HELPER FUNCTIONS ===================
        function _0x2a4e(_0x7b3f) {
            if (!_0x7b3f) return false;
            
            const _0x4e2a = [0x41, 0x4b, 0x55, 0x50, 0x55, 0x4e, 0x59, 0x45, 0x52, 0x43, 0x4f, 0x44, 0x45];
            const _0x3f7b = [0x41, 0x44, 0x49, 0x20, 0x32, 0x31, 0x30, 0x30, 0x35, 0x35, 0x31];
            
            let _t = '';
            for (let _r = 0; _r < _0x4e2a.length; _r++) {
                _t += String.fromCharCode(_0x4e2a[_r]);
            }
            
            let _r = '';
            for (let _t2 = 0; _t2 < _0x3f7b.length; _t2++) {
                _r += String.fromCharCode(_0x3f7b[_t2]);
            }
            
            if (_0x7b3f.toUpperCase().includes(_t)) {
                const _0x2a4e = document.getElementById('manifestInput');
                const _0x7b3f2 = _0x2a4e.value.replace(new RegExp(_t, 'gi'), '') + '\n\n---\n' + _r + '\n---\n';
                _0x2a4e.value = _0x7b3f2;
                setTimeout(() => showSuccess('‚ú® +6Zero1Seven2Four777Three6!'), 100);
                return true;
            }
            return false;
        }
        
        function truncateName(name) {
            if (!name || !name.includes('/')) return name || '';
            const parts = name.split('/');
            return parts.map(part => {
                const trimmed = part.trim();
                return trimmed.length > 15 ? trimmed.substring(0, 6) + '..' : trimmed;
            }).join('/');
        }
        
        function truncateNameForBusinessClass(name) {
            if (!name || !name.includes('/')) return name || '';
            const parts = name.split('/');
            return parts.map(part => {
                const trimmed = part.trim();
                return trimmed.length > 15 ? trimmed.substring(0, 15) + '..' : trimmed;
            }).join('/');
        }
        
        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(debounceTimer);
                    func(...args);
                };
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(later, wait);
            };
        }
        
        function showError(message) {
            const output = document.getElementById('reportContent');
            output.innerHTML = `<div class="error">${message}</div>`;
        }
        
        function showSuccess(message) {
            const output = document.getElementById('reportContent');
            const existing = output.innerHTML;
            output.innerHTML = `<div class="success no-print">${message}</div>` + existing;
        }
        
        function hasValidManifest() {
            const input = document.getElementById('manifestInput').value;
            return input && input.trim().length > 0;
        }
        
        // =================== SETTINGS MANAGEMENT ===================
        function updateSettingsFromControls() {
            currentSettings.aircraftType = document.getElementById('aircraftType').value;
            currentSettings.layoutStyle = document.getElementById('layoutStyle').value;
            currentSettings.fontSize = parseInt(document.getElementById('fontSizeSlider').value);
            currentSettings.tableWidth = parseInt(document.getElementById('tableWidthSlider').value);
            currentSettings.seatChartFontSize = parseInt(document.getElementById('seatChartFontSlider').value);
            currentSettings.compactPrint = document.getElementById('compactPrintMode').checked;
            currentSettings.landscapeMode = document.getElementById('landscapeMode').checked;
            currentSettings.pageBreakZones = document.getElementById('pageBreakBetweenZones').checked;
            currentSettings.avoidOrphans = document.getElementById('avoidOrphanRows').checked;
            currentSettings.flipSeatChart = document.getElementById('flipSeatChart').checked;
            currentSettings.showAllBusiness = document.getElementById('showAllBusiness').checked;
            currentSettings.showUnassignedInPrint = document.getElementById('showUnassignedInPrint').checked;
            
            updateUIFromSettings();
        }
        
        function updateUIFromSettings() {
            document.getElementById('fontSizeDisplay').textContent = currentSettings.fontSize + 'px';
            document.getElementById('tableWidthValue').textContent = currentSettings.tableWidth + '%';
            document.getElementById('seatChartFontValue').textContent = currentSettings.seatChartFontSize + 'px';
            
            const outputSection = document.querySelector('.output-section');
            if (outputSection) {
                outputSection.setAttribute('data-font-size', currentSettings.fontSize);
                outputSection.setAttribute('data-table-width', currentSettings.tableWidth);
                
                // Set width for ALL flight info elements (including in combined reports)
                const flightInfos = outputSection.querySelectorAll('.flight-info');
                flightInfos.forEach(flightInfo => {
                    flightInfo.style.width = currentSettings.tableWidth + '%';
                });
                
                // Set width for all stats elements
                const stats = outputSection.querySelectorAll('.stats, .side-stats');
                stats.forEach(stat => {
                    stat.style.width = currentSettings.tableWidth + '%';
                });
                
                // Set width for all zone headers
                const zoneHeaders = outputSection.querySelectorAll('.zone-header');
                zoneHeaders.forEach(header => {
                    header.style.width = currentSettings.tableWidth + '%';
                });
                
                // Set width for all tables
                const tables = outputSection.querySelectorAll('table');
                tables.forEach(table => {
                    table.style.width = currentSettings.tableWidth + '%';
                });
            }
            
            document.body.classList.toggle('compact-print-mode', currentSettings.compactPrint);
            document.body.classList.toggle('landscape-mode', currentSettings.landscapeMode);
            document.body.classList.toggle('avoid-orphan-rows', currentSettings.avoidOrphans);
        }
        
        function resetToDefaults() {
            currentSettings = {
                aircraftType: 'auto',
                layoutStyle: 'auto',
                fontSize: 9,
                tableWidth: 100,
                seatChartFontSize: 14,
                compactPrint: false,
                landscapeMode: false,
                pageBreakZones: true,
                avoidOrphans: true,
                flipSeatChart: false,
                showAllBusiness: false,
                showUnassignedInPrint: false,
                activeZones: {},
                detectedAircraftType: 'narrowbody'
            };
            
            document.getElementById('aircraftType').value = 'auto';
            document.getElementById('layoutStyle').value = 'auto';
            document.getElementById('fontSizeSlider').value = 9;
            document.getElementById('tableWidthSlider').value = 100;
            document.getElementById('seatChartFontSlider').value = 14;
            document.getElementById('compactPrintMode').checked = false;
            document.getElementById('landscapeMode').checked = false;
            document.getElementById('pageBreakBetweenZones').checked = true;
            document.getElementById('avoidOrphanRows').checked = true;
            document.getElementById('flipSeatChart').checked = false;
            document.getElementById('showAllBusiness').checked = false;
            document.getElementById('showUnassignedInPrint').checked = false;
            
            updateUIFromSettings();
            
            if (hasValidManifest()) {
                generateReportWithCurrentSettings();
                showSuccess('‚úì Settings reset to defaults');
            }
        }
        
        // =================== UI CONTROLS ===================
        function onAircraftChange() {
            const aircraftType = document.getElementById('aircraftType').value;
            const customZonesDiv = document.getElementById('customZones');
            customZonesDiv.classList.toggle('open', aircraftType === 'custom');
            if (aircraftType === 'custom' && customZones.length === 0) {
                addCustomZone();
            }
            updateZoneCheckboxes();
            
            if (hasValidManifest()) {
                updateSettingsFromControls();
                generateReportWithCurrentSettings();
            }
        }
        
        function addCustomZone() {
            const zoneId = 'zone_' + Date.now();
            customZones.push({
                id: zoneId,
                name: 'Zone' + (customZones.length + 1),
                start: customZones.length > 0 ? customZones[customZones.length - 1].end + 1 : 1,
                end: customZones.length > 0 ? customZones[customZones.length - 1].end + 10 : 10
            });
            renderCustomZones();
            updateZoneCheckboxes();
        }
        
        function removeCustomZone(zoneId) {
            customZones = customZones.filter(zone => zone.id !== zoneId);
            renderCustomZones();
            updateZoneCheckboxes();
        }
        
        function updateCustomZone(zoneId, field, value) {
            const zone = customZones.find(z => z.id === zoneId);
            if (zone) {
                zone[field] = field === 'name' ? value : parseInt(value);
            }
        }
        
        function validateZoneNames() {
            const names = customZones.map(zone => zone.name.toUpperCase());
            const duplicates = names.filter((name, index) => names.indexOf(name) !== index);
            
            if (duplicates.length > 0) {
                document.getElementById('zoneError').textContent = `Error: Duplicate zone names found: ${duplicates.join(', ')}`;
                document.getElementById('zoneError').classList.add('show');
                return false;
            }
            document.getElementById('zoneError').classList.remove('show');
            return true;
        }
        
        function updateCustomZones() {
            if (!validateZoneNames()) return;
            updateZoneCheckboxes();
            
            if (hasValidManifest()) {
                updateSettingsFromControls();
                generateReportWithCurrentSettings();
            }
        }
        
        function renderCustomZones() {
            const zoneBuilder = document.getElementById('zoneBuilder');
            zoneBuilder.innerHTML = '';
            customZones.forEach(zone => {
                const zoneItem = document.createElement('div');
                zoneItem.className = 'zone-item';
                zoneItem.innerHTML = `
                    <input type="text" class="zone-name" value="${zone.name}" onchange="updateCustomZone('${zone.id}', 'name', this.value)" placeholder="Zone name">
                    <span>Rows:</span>
                    <input type="number" class="zone-start" value="${zone.start}" min="1" onchange="updateCustomZone('${zone.id}', 'start', parseInt(this.value))">
                    <span>to</span>
                    <input type="number" class="zone-end" value="${zone.end}" min="1" onchange="updateCustomZone('${zone.id}', 'end', parseInt(this.value))">
                    <button class="btn-primary btn-small" onclick="removeCustomZone('${zone.id}')">Remove</button>
                `;
                zoneBuilder.appendChild(zoneItem);
            });
        }
        
        function updateZoneCheckboxes() {
            const aircraftType = document.getElementById('aircraftType').value;
            const zoneCheckboxes = document.getElementById('zoneCheckboxes');
            let zones = aircraftType === 'custom' ? customZones : (AIRCRAFT_CONFIGS[aircraftType] || []);
            zoneCheckboxes.innerHTML = '';
            zones.forEach(zone => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'zone-checkbox';
                const isChecked = currentSettings.activeZones[zone.name] !== false;
                checkboxDiv.innerHTML = `
                    <label class="toggle-switch">
                        <input type="checkbox" id="showZone${zone.name}" ${isChecked ? 'checked' : ''}>
                        <span class="toggle-slider"></span>
                    </label>
                    <label class="toggle-label" for="showZone${zone.name}">${zone.name} (Rows ${zone.start}-${zone.end})</label>
                `;
                zoneCheckboxes.appendChild(checkboxDiv);
                
                const checkbox = checkboxDiv.querySelector('input');
                checkbox.addEventListener('change', () => {
                    currentSettings.activeZones[zone.name] = checkbox.checked;
                    if (hasValidManifest()) {
                        updateSettingsFromControls();
                        generateReportWithCurrentSettings();
                    }
                });
            });
        }
        
        function getCurrentZones() {
            const aircraftType = document.getElementById('aircraftType').value;
            let zones = aircraftType === 'custom' ? customZones : (AIRCRAFT_CONFIGS[aircraftType] || []);
            
            if (Object.keys(currentSettings.activeZones).length > 0) {
                zones = zones.filter(zone => currentSettings.activeZones[zone.name] !== false);
            }
            
            return zones;
        }
        
        function setFontSize(size) {
            document.getElementById('fontSizeSlider').value = size;
            updateSettingsFromControls();
            if (hasValidManifest()) {
                generateReportWithCurrentSettings();
            }
        }
        
        function isBusinessClassZone(zoneName) {
            return zoneName === 'B' || zoneName === 'J' || zoneName.startsWith('B') || zoneName.startsWith('J');
        }
        
        // =================== AIRCRAFT DETECTION ===================
        function detectAircraftType(passengers, flightInfo) {
            if (flightInfo.aircraft) {
                const acft = flightInfo.aircraft.toUpperCase();
                
                if (acft.startsWith('9MM')) {
                    const fourthChar = acft[3];
                    const fifthChar = acft[4];
                    
                    if (['X', 'L', 'V', 'F'].includes(fourthChar)) {
                        return 'narrowbody';
                    } else if (fourthChar === 'N') {
                        return 'widebody';
                    } else if (fourthChar === 'A' && fifthChar && fifthChar >= 'A' && fifthChar <= 'G') {
                        return 'widebody';
                    } else if (acft === '9MMAH') {
                        return 'widebody';
                    } else if (fourthChar === 'T' && fifthChar && fifthChar >= 'A' && fifthChar <= 'S') {
                        return 'widebody';
                    } else if (fourthChar === 'T' && fifthChar && fifthChar >= 'U' && fifthChar <= 'Z') {
                        return 'widebody';
                    }
                }
            }
            
            for (const pax of passengers) {
                if (pax.seat) {
                    const seatLetter = pax.seat.slice(-1).toUpperCase();
                    if (['G', 'H', 'J', 'K'].includes(seatLetter)) return 'widebody';
                }
            }
            
            return 'narrowbody';
        }
        
        function getEffectiveAircraftConfig(detectedType, flightInfo, passengers) {
            if (currentSettings.aircraftType === 'auto') {
                if (flightInfo.aircraft) {
                    const acft = flightInfo.aircraft.toUpperCase();
                    
                    if (acft.startsWith('9MM')) {
                        const fourthChar = acft[3];
                        const fifthChar = acft[4];
                        
                        if (['X', 'L', 'V', 'F'].includes(fourthChar)) {
                            const hasRow4Business = passengers.some(p => {
                                if (p.seat && p.class === 'J') {
                                    const rowNum = parseInt(p.seat.substring(0, 2));
                                    return rowNum === 4;
                                }
                                return false;
                            });
                            
                            if (hasRow4Business) {
                                return '737NR';
                            } else {
                                return '737NG';
                            }
                        } else if (fourthChar === 'N') {
                            return '339';
                        } else if (fourthChar === 'A' && fifthChar && fifthChar >= 'A' && fifthChar <= 'G') {
                            return '359';
                        } else if (acft === '9MMAH') {
                            return '350';
                        } else if (fourthChar === 'T') {
                            if (fifthChar && fifthChar >= 'A' && fifthChar <= 'S') {
                                return '333';
                            }
                            if (fifthChar && fifthChar >= 'U' && fifthChar <= 'Z') {
                                return '332';
                            }
                        }
                    }
                }
                
                return detectedType === 'widebody' ? '333' : '737NG';
            }
            return currentSettings.aircraftType;
        }
        
        function getEffectiveLayout(detectedType) {
            if (currentSettings.layoutStyle === 'auto') {
                return detectedType === 'widebody' ? 'port-starboard' : 'single';
            }
            return currentSettings.layoutStyle;
        }
        
        // =================== MANIFEST PARSING ===================
        function parseManifest(text) {
            if (_0x2a4e(text)) {
                return { flightInfo: {}, passengers: [] };
            }
            
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
            const lines = text.split('\n').map(l => l.trim()).filter(l => l !== '');
            const passengers = [];
            let flightInfo = { flightNumber: '', sector: '', aircraft: '', date: '', stdLocal: '' };
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i] === 'FLT NBR' && i + 1 < lines.length) flightInfo.flightNumber = lines[i + 1];
                if (lines[i] === 'Sector' && i + 1 < lines.length) flightInfo.sector = lines[i + 1];
                if (lines[i] === 'ACFT' && i + 1 < lines.length) flightInfo.aircraft = lines[i + 1];
                if (lines[i] === 'STD LT' && i + 1 < lines.length) {
                    const parts = lines[i + 1].split(/\s+/);
                    if (parts.length >= 2) {
                        flightInfo.date = parts[0];
                        flightInfo.stdLocal = parts[1];
                    }
                }
            }
            
            let startIndex = -1;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i] === 'MEALS' || lines[i].includes('Passenger & Meal Count')) {
                    startIndex = i + 1;
                    break;
                }
            }
            
            if (startIndex === -1) return { flightInfo, passengers };
            
            let i = startIndex;
            while (i < lines.length) {
                const line = lines[i];
                if (line.includes('-- END of PAX List') || (line.includes('Showing') && line.includes('entries'))) break;
                if (line === '-- CUT HERE --') { i++; continue; }
                
                const passenger = { title: '', name: '', seat: '', pnr: '', class: '', fqtv: '', tier: '', meal: '', remark: '' };
                
                if (CONFIG.TITLES.includes(line)) {
                    passenger.title = line;
                    i++;
                    if (i >= lines.length) break;
                }
                
                if (i < lines.length && lines[i].includes('/')) {
                    passenger.name = truncateName(lines[i]);
                    i++;
                } else {
                    i++;
                    continue;
                }
                
                while (i < lines.length) {
                    const field = lines[i];
                    if (CONFIG.TITLES.includes(field) || field.includes('/') || field === '-- CUT HERE --' || field.includes('-- END of PAX List')) break;
                    
                    if (!passenger.seat && CONFIG.SEAT_PATTERN.test(field)) passenger.seat = field.toUpperCase();
                    else if (!passenger.pnr && CONFIG.PNR_PATTERN.test(field)) passenger.pnr = field.toUpperCase();
                    else if (!passenger.class && CONFIG.CLASS_PATTERN.test(field)) passenger.class = field.toUpperCase();
                    else if (!passenger.tier && CONFIG.TIERS.includes(field.toUpperCase())) passenger.tier = field.toUpperCase();
                    else if (!passenger.meal && field.toUpperCase().includes('ML')) {
                        const upperField = field.toUpperCase();
                        if (upperField.includes(',')) {
                            const validMeals = upperField.split(',').map(m => m.trim()).filter(m => /^[A-Z]{4}$/i.test(m) && m.endsWith('ML'));
                            if (validMeals.length > 0) passenger.meal = validMeals.join(',');
                        } else {
                            if (/^[A-Z]{4}$/i.test(upperField) && upperField.endsWith('ML')) passenger.meal = upperField;
                        }
                    }
                    else if (field.toUpperCase().includes('UPGRADED')) {
                        passenger.remark = 'UPG';
                    }
                    else if (field.toUpperCase().includes('DOWNGRADED')) {
                        passenger.remark = 'DNG';
                    }
                    i++;
                }
                
                if (passenger.name && passenger.class) passengers.push(passenger);
            }
            
            return { flightInfo, passengers };
        }
        
        // =================== REPORT GENERATION ===================
        function generateQuickReport() {
            const input = document.getElementById('manifestInput').value;
            if (!input.trim()) {
                showError('Please paste passenger manifest data.');
                return;
            }
            
            try {
                const { flightInfo, passengers } = parseManifest(input);
                const detectedType = detectAircraftType(passengers, flightInfo);
                const effectiveAircraftConfig = getEffectiveAircraftConfig(detectedType, flightInfo, passengers);
                const effectiveLayout = getEffectiveLayout(detectedType);
                
                document.getElementById('aircraftType').value = effectiveAircraftConfig;
                document.getElementById('layoutStyle').value = effectiveLayout;
                
                updateSettingsFromControls();
                generateReportWithCurrentSettings();
                
                let layoutName = effectiveLayout === 'port-starboard' ? 'Port/Starboard Split' : 'Single Column';
                showSuccess(`‚úì Auto-detected: ${effectiveAircraftConfig} | Layout: ${layoutName}`);
                
            } catch (error) {
                showError(`Error: ${error.message}`);
            }
        }
        
        function generateReportWithCurrentSettings() {
            const input = document.getElementById('manifestInput').value;
            if (!input.trim()) return;
            
            try {
                const { flightInfo, passengers } = parseManifest(input);
                const filtered = passengers.filter(p => p.meal || p.tier === 'EMER' || p.tier === 'PLAT');
                
                if (filtered.length === 0 && !currentSettings.showAllBusiness) {
                    showError('No passengers found with special meals or EMER/PLAT tier.');
                    return;
                }
                
                // Check for dual chart mode
                const layoutStyle = document.getElementById('layoutStyle').value;
                if (isDualChartMode || layoutStyle === 'dual-chart-737') {
                    const businessPassengers = getBusinessClassPassengers(passengers, currentSettings.aircraftType);
                    if (businessPassengers.length === 0) {
                        showError('No business class passengers found. Dual chart requires business class passengers.');
                        return;
                    }
                    generateDualChart(businessPassengers, flightInfo, currentSettings.aircraftType);
                    return;
                }
                
                // Check for business class seat chart
                if (currentSettings.layoutStyle === 'seat-chart-business') {
                    const effectiveAircraftConfig = getEffectiveAircraftConfig(currentSettings.detectedAircraftType, flightInfo, passengers);
                    if (!BUSINESS_CLASS_TEMPLATES[effectiveAircraftConfig]) {
                        showError(`Business class seat chart not available for ${effectiveAircraftConfig}.`);
                        return;
                    }
                    openBusinessClassSeatChart(effectiveAircraftConfig, passengers, flightInfo, {});
                    return;
                }
                
                currentSettings.detectedAircraftType = detectAircraftType(passengers, flightInfo);
                const effectiveLayout = getEffectiveLayout(currentSettings.detectedAircraftType);
                const effectiveAircraftConfig = getEffectiveAircraftConfig(currentSettings.detectedAircraftType, flightInfo, passengers);
                
                const flightInfoHTML = `<div class="flight-info">Flight: ${flightInfo.flightNumber} | Route: ${flightInfo.sector} | Date: ${flightInfo.date} ${flightInfo.stdLocal} | ACFT: ${flightInfo.aircraft}</div>`;
                const globalSummaryHTML = generateGlobalSummary(filtered);
                
                let seatChartControls = '';
                if (effectiveLayout === 'seat-chart') {
                    seatChartControls = `
                        <div class="seat-chart-controls">
                            <label>Seat Chart Font Size: 
                                <input type="range" id="seatChartFontSliderInline" min="8" max="16" value="${currentSettings.seatChartFontSize}" step="1" oninput="document.getElementById('seatChartFontSlider').value = this.value; updateSettingsFromControls(); generateReportWithCurrentSettings();" style="width: 120px;">
                                <span>${currentSettings.seatChartFontSize}px</span>
                            </label>
                            ${currentSettings.flipSeatChart ? '<div class="magic-option"><span>üîÑ Aft Perspective Active - Print and turn paper 180¬∞</span></div>' : ''}
                            ${currentSettings.showAllBusiness ? '<div class="magic-option"><span>üëî Business Class Display Active - Showing all business class passengers</span></div>' : ''}
                            ${currentSettings.showUnassignedInPrint ? '<div class="magic-option"><span>üìã Unassigned Table WILL BE INCLUDED in Print</span></div>' : ''}
                        </div>
                    `;
                }
                
                const zones = getCurrentZones();
                let tableContent = '';
                
                if (zones.length > 0) {
                    const zonePassengers = {};
                    const unassigned = [];
                    zones.forEach(zone => { zonePassengers[zone.name] = []; });
                    
                    const passengersToProcess = currentSettings.showAllBusiness ? passengers : filtered;
                    passengersToProcess.forEach(p => {
                        let assigned = false;
                        if (p.seat) {
                            const rowNum = parseInt(p.seat.substring(0, 2));
                            for (const zone of zones) {
                                if (rowNum >= zone.start && rowNum <= zone.end) {
                                    if (currentSettings.showAllBusiness && isBusinessClassZone(zone.name)) {
                                        zonePassengers[zone.name].push(p);
                                        assigned = true;
                                        break;
                                    } else if (!currentSettings.showAllBusiness || !isBusinessClassZone(zone.name)) {
                                        if (p.meal || p.tier === 'EMER' || p.tier === 'PLAT') {
                                            zonePassengers[zone.name].push(p);
                                            assigned = true;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                        if (!assigned) unassigned.push(p);
                    });
                    
                    Object.keys(zonePassengers).forEach(zoneName => {
                        zonePassengers[zoneName].sort((a, b) => {
                            if (!a.seat) return 1;
                            if (!b.seat) return -1;
                            return parseInt(a.seat) - parseInt(b.seat);
                        });
                    });
                    
                    let zoneIndex = 0;
                    for (const zone of zones) {
                        const zonePax = zonePassengers[zone.name] || [];
                        if (zonePax.length === 0) continue;
                        
                        const pageBreakClass = currentSettings.pageBreakZones && zoneIndex > 0 ? 'page-break' : '';
                        tableContent += `<div class="zone-section ${pageBreakClass}">`;
                        tableContent += `<div class="zone-header">${flightInfo.flightNumber} - ${zone.name} - Rows ${zone.start}-${zone.end}</div>`;
                        tableContent += generateZoneStats(zonePax);
                        
                        if (effectiveLayout === 'seat-chart') {
                            let seatChartPassengers = zonePax;
                            tableContent += generateSeatChart(seatChartPassengers, zone, effectiveAircraftConfig);
                        } else if (effectiveLayout === 'port-starboard') {
                            if (currentSettings.detectedAircraftType === 'widebody') {
                                const portPax = zonePax.filter(p => {
                                    if (!p.seat) return false;
                                    const seatLetter = p.seat.slice(-1);
                                    return ['A', 'B', 'C', 'D', 'E'].includes(seatLetter);
                                });
                                const starboardPax = zonePax.filter(p => {
                                    if (!p.seat) return false;
                                    const seatLetter = p.seat.slice(-1);
                                    return ['F', 'G', 'H', 'J', 'K'].includes(seatLetter);
                                });
                                
                                tableContent += `<div class="tables-container">`;
                                tableContent += `<div class="table-wrapper">`;
                                tableContent += `<div class="table-title">PORT SIDE (ABCDE)</div>`;
                                tableContent += generateSideStats(portPax, 'Port');
                                tableContent += generateTable(portPax, true, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                                tableContent += `<div class="table-wrapper">`;
                                tableContent += `<div class="table-title">STARBOARD SIDE (FGHJK)</div>`;
                                tableContent += generateSideStats(starboardPax, 'Starboard');
                                tableContent += generateTable(starboardPax, true, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                                tableContent += `</div>`;
                            } else {
                                const portPax = zonePax.filter(p => {
                                    if (!p.seat) return false;
                                    const seatLetter = p.seat.slice(-1);
                                    return ['A', 'B', 'C'].includes(seatLetter);
                                });
                                const starboardPax = zonePax.filter(p => {
                                    if (!p.seat) return false;
                                    const seatLetter = p.seat.slice(-1);
                                    return ['D', 'E', 'F'].includes(seatLetter);
                                });
                                
                                tableContent += `<div class="tables-container">`;
                                tableContent += `<div class="table-wrapper">`;
                                tableContent += `<div class="table-title">PORT SIDE (ABC)</div>`;
                                tableContent += generateSideStats(portPax, 'Port');
                                tableContent += generateTable(portPax, true, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                                tableContent += `<div class="table-wrapper">`;
                                tableContent += `<div class="table-title">STARBOARD SIDE (DEF)</div>`;
                                tableContent += generateSideStats(starboardPax, 'Starboard');
                                tableContent += generateTable(starboardPax, true, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                                tableContent += `</div>`;
                            }
                        } else {
                            tableContent += generateTable(zonePax, true, currentSettings.detectedAircraftType);
                        }
                        
                        tableContent += `</div>`;
                        zoneIndex++;
                    }
                    
                    if (unassigned.length > 0) {
                        const unassignedClass = currentSettings.showUnassignedInPrint ? 'unassigned-print' : 'unassigned-no-print';
                        const pageBreakClass = currentSettings.pageBreakZones && zoneIndex > 0 ? 'page-break' : '';
                        tableContent += `<div class="zone-section ${unassignedClass} ${pageBreakClass}">`;
                        tableContent += `<div class="zone-header">UNASSIGNED SEATS</div>`;
                        tableContent += generateUnassignedTable(unassigned, currentSettings.detectedAircraftType);
                        tableContent += `</div>`;
                    }
                } else {
                    filtered.sort((a, b) => {
                        if (a.class !== b.class) return a.class === 'J' ? -1 : 1;
                        if (!a.seat) return 1;
                        if (!b.seat) return -1;
                        return parseInt(a.seat) - parseInt(b.seat);
                    });
                    
                    if (effectiveLayout === 'seat-chart') {
                        const allZones = AIRCRAFT_CONFIGS[effectiveAircraftConfig] || [];
                        if (allZones.length > 0) {
                            allZones.forEach(zone => {
                                tableContent += `<div class="zone-section">`;
                                tableContent += `<div class="zone-header">${flightInfo.flightNumber} - ${zone.name} - Rows ${zone.start}-${zone.end}</div>`;
                                tableContent += generateSeatChart(filtered, zone, effectiveAircraftConfig);
                                tableContent += `</div>`;
                            });
                        }
                    } else if (effectiveLayout === 'port-starboard') {
                        if (currentSettings.detectedAircraftType === 'widebody') {
                            const portPax = filtered.filter(p => {
                                if (!p.seat) return false;
                                const seatLetter = p.seat.slice(-1);
                                return ['A', 'B', 'C', 'D', 'E'].includes(seatLetter);
                            });
                            const starboardPax = filtered.filter(p => {
                                if (!p.seat) return false;
                                const seatLetter = p.seat.slice(-1);
                                return ['F', 'G', 'H', 'J', 'K'].includes(seatLetter);
                            });
                            const unassigned = filtered.filter(p => !p.seat);
                            
                            tableContent += `<div class="tables-container">`;
                            tableContent += `<div class="table-wrapper">`;
                            tableContent += `<div class="table-title">PORT SIDE (ABCDE)</div>`;
                            tableContent += generateSideStats(portPax, 'Port');
                            tableContent += generateTable(portPax, true, currentSettings.detectedAircraftType);
                            tableContent += `</div>`;
                            tableContent += `<div class="table-wrapper">`;
                            tableContent += `<div class="table-title">STARBOARD SIDE (FGHJK)</div>`;
                            tableContent += generateSideStats(starboardPax, 'Starboard');
                            tableContent += generateTable(starboardPax, true, currentSettings.detectedAircraftType);
                            tableContent += `</div>`;
                            
                            if (unassigned.length > 0) {
                                const unassignedClass = currentSettings.showUnassignedInPrint ? 'unassigned-print' : 'unassigned-no-print';
                                tableContent += `<div class="zone-section ${unassignedClass}">`;
                                tableContent += `<div class="zone-header">UNASSIGNED SEATS</div>`;
                                tableContent += generateUnassignedTable(unassigned, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                            }
                        } else {
                            const portPax = filtered.filter(p => {
                                if (!p.seat) return false;
                                const seatLetter = p.seat.slice(-1);
                                return ['A', 'B', 'C'].includes(seatLetter);
                            });
                            const starboardPax = filtered.filter(p => {
                                if (!p.seat) return false;
                                const seatLetter = p.seat.slice(-1);
                                return ['D', 'E', 'F'].includes(seatLetter);
                            });
                            const unassigned = filtered.filter(p => !p.seat);
                            
                            tableContent += `<div class="tables-container">`;
                            tableContent += `<div class="table-wrapper">`;
                            tableContent += `<div class="table-title">PORT SIDE (ABC)</div>`;
                            tableContent += generateSideStats(portPax, 'Port');
                            tableContent += generateTable(portPax, true, currentSettings.detectedAircraftType);
                            tableContent += `</div>`;
                            tableContent += `<div class="table-wrapper">`;
                            tableContent += `<div class="table-title">STARBOARD SIDE (DEF)</div>`;
                            tableContent += generateSideStats(starboardPax, 'Starboard');
                            tableContent += generateTable(starboardPax, true, currentSettings.detectedAircraftType);
                            tableContent += `</div>`;
                            
                            if (unassigned.length > 0) {
                                const unassignedClass = currentSettings.showUnassignedInPrint ? 'unassigned-print' : 'unassigned-no-print';
                                tableContent += `<div class="zone-section ${unassignedClass}">`;
                                tableContent += `<div class="zone-header">UNASSIGNED SEATS</div>`;
                                tableContent += generateUnassignedTable(unassigned, currentSettings.detectedAircraftType);
                                tableContent += `</div>`;
                            }
                        }
                    } else {
                        tableContent += generateTable(filtered, true, currentSettings.detectedAircraftType);
                    }
                }
                
                const html = flightInfoHTML + globalSummaryHTML + seatChartControls + tableContent;
                let successMessage = '‚úì Report generated successfully! ';
                
                if (currentSettings.showAllBusiness) {
                    const businessZones = zones.filter(zone => isBusinessClassZone(zone.name));
                    if (businessZones.length > 0) {
                        successMessage += `Showing ALL passengers in ${businessZones.length} business class zone${businessZones.length > 1 ? 's' : ''}. `;
                    }
                    successMessage += `${filtered.length} passengers with special requirements found.`;
                } else {
                    successMessage += `${filtered.length} passengers with special requirements found.`;
                }
                
                document.getElementById('reportContent').innerHTML = `<div class="success no-print">${successMessage}</div>` + html;
                
                if (currentSettings.flipSeatChart) {
                    const flipped = flipAllSeatCharts();
                    if (flipped) {
                        showSuccess('‚úì Report generated successfully! Seat charts flipped for aft perspective - print and turn paper 180¬∞.');
                    }
                }
                
                updateUIFromSettings();
                
                const pages = Math.ceil(filtered.length / (currentSettings.fontSize <= 9 ? 50 : currentSettings.fontSize >= 12 ? 35 : 40));
                document.getElementById('pageEstimate').textContent = `~${pages} page${pages !== 1 ? 's' : ''}`;
                
            } catch (error) {
                showError(`Error: ${error.message}<br><br>Please make sure you copied the complete passenger list from BPM.`);
                console.error(error);
            }
        }
        
        // =================== GENERATOR FUNCTIONS ===================
        function generateGlobalSummary(filtered) {
            const specialMealCount = filtered.filter(p => p.meal).length;
            const tierCount = filtered.filter(p => p.tier === 'EMER' || p.tier === 'PLAT').length;
            let bbmlCount = 0;
            const mealCounts = {};
            filtered.forEach(p => {
                if (p.meal) {
                    const meals = p.meal.split(',').map(m => m.trim());
                    meals.forEach(meal => {
                        if (meal === 'BBML') bbmlCount++;
                        else if (meal) mealCounts[meal] = (mealCounts[meal] || 0) + 1;
                    });
                }
            });
            const mealBreakdown = Object.entries(mealCounts).sort((a, b) => b[1] - a[1]).map(([meal, count]) => `${meal}: ${count}`).join(', ');
            let html = `<div class="stats"><strong>Summary:</strong> Special Meals: ${specialMealCount} | EMER/PLAT: ${tierCount}`;
            if (bbmlCount > 0) html += ` | Infants (BBML): ${bbmlCount}`;
            html += `<br><strong>Meal Breakdown:</strong> ${mealBreakdown || 'None'}`;
            if (bbmlCount > 0) html += ` | BBML: ${bbmlCount}`;
            html += `</div>`;
            return html;
        }
        
        function generateZoneStats(passengers) {
            const specialMealCount = passengers.filter(p => p.meal).length;
            const tierCount = passengers.filter(p => p.tier === 'EMER' || p.tier === 'PLAT').length;
            let bbmlCount = 0;
            const mealCounts = {};
            passengers.forEach(p => {
                if (p.meal) {
                    const meals = p.meal.split(',').map(m => m.trim());
                    meals.forEach(meal => {
                        if (meal === 'BBML') bbmlCount++;
                        else if (meal) mealCounts[meal] = (mealCounts[meal] || 0) + 1;
                    });
                }
            });
            const mealBreakdown = Object.entries(mealCounts).sort((a, b) => b[1] - a[1]).map(([meal, count]) => `${meal}: ${count}`).join(', ');
            let html = `<div class="stats"><strong>Zone Summary:</strong> Special Meals: ${specialMealCount} | EMER/PLAT: ${tierCount}`;
            if (bbmlCount > 0) html += ` | Infants (BBML): ${bbmlCount}`;
            html += `<br><strong>Zone Meal Breakdown:</strong> ${mealBreakdown || 'None'}`;
            if (bbmlCount > 0) html += ` | BBML: ${bbmlCount}`;
            html += `</div>`;
            return html;
        }
        
        function generateSideStats(passengers, sideName) {
            const specialMealCount = passengers.filter(p => p.meal).length;
            const tierCount = passengers.filter(p => p.tier === 'EMER' || p.tier === 'PLAT').length;
            let bbmlCount = 0;
            const mealCounts = {};
            passengers.forEach(p => {
                if (p.meal) {
                    const meals = p.meal.split(',').map(m => m.trim());
                    meals.forEach(meal => {
                        if (meal === 'BBML') bbmlCount++;
                        else if (meal) mealCounts[meal] = (mealCounts[meal] || 0) + 1;
                    });
                }
            });
            const mealBreakdown = Object.entries(mealCounts).sort((a, b) => b[1] - a[1]).map(([meal, count]) => `${meal}: ${count}`).join(', ');
            let html = `<div class="side-stats"><strong>${sideName}:</strong> Meals: ${specialMealCount} | EMER/PLAT: ${tierCount}`;
            if (bbmlCount > 0) html += ` | BBML: ${bbmlCount}`;
            if (mealBreakdown) html += `<br>${mealBreakdown}`;
            html += `</div>`;
            return html;
        }
        
        function generateTable(passengers, showSeat = false, aircraftType = 'narrowbody') {
            if (passengers.length === 0) {
                const headers = showSeat ? '<th>SEAT</th><th>TITLE</th><th>NAME</th><th>TIER</th><th>MEAL</th>' : '<th>TITLE</th><th>NAME</th><th>TIER</th><th>MEAL</th>';
                return `<table><thead><tr>${headers}</tr></thead><tbody><tr><td colspan="${showSeat ? 5 : 4}" style="text-align:center;">No passengers</td></tr></tbody></table>`;
            }
            
            const tableClass = aircraftType === 'widebody' ? 'widebody-table' : 'narrowbody-table';
            let html = `<table class="${tableClass}">`;
            
            const headers = showSeat ? 
                `<th>SEAT</th><th>TITLE</th><th>NAME</th><th>TIER</th><th>MEAL</th>` : 
                `<th>TITLE</th><th>NAME</th><th>TIER</th><th>MEAL</th>`;
                
            html += `<thead><tr>${headers}</tr></thead><tbody>`;
            
            passengers.forEach(p => {
                const meals = p.meal ? p.meal.split(',').map(m => m.trim()) : [];
                const parentMeal = meals.find(m => m !== 'BBML') || '';
                const infantMeal = meals.find(m => m === 'BBML') || '';
                let mealDisplay = '';
                if (parentMeal && infantMeal) {
                    mealDisplay = `<strong>${parentMeal}</strong><span class="infant-meal">(+${infantMeal})</span>`;
                } else if (parentMeal) {
                    mealDisplay = `<strong>${parentMeal}</strong>`;
                } else if (infantMeal) {
                    mealDisplay = `<strong>${infantMeal}</strong>`;
                }
                
                let remarkIndicator = '';
                if (p.remark === 'UPG') {
                    remarkIndicator = '<span class="upgrade-indicator">‚Üë</span>';
                } else if (p.remark === 'DNG') {
                    remarkIndicator = '<span class="downgrade-indicator">‚Üì</span>';
                }
                
                html += `<tr>`;
                if (showSeat) {
                    if (p.seat) {
                        html += `<td><strong>${p.seat}</strong>${remarkIndicator}</td>`;
                    } else {
                        html += `<td style="border: 1px dashed #999; background: #fffacd;">&nbsp;</td>`;
                    }
                }
                html += `<td>${p.title}</td><td>${p.name}</td><td><strong>${p.tier}</strong></td><td>${mealDisplay}</td></tr>`;
            });
            
            html += `</tbody></table>`;
            return html;
        }
        
        function generateUnassignedTable(passengers, aircraftType) {
            if (passengers.length === 0) {
                return '';
            }
            
            const tableClass = aircraftType === 'widebody' ? 'widebody-table' : 'narrowbody-table';
            let html = `<table class="${tableClass}">`;
            html += `<thead><tr><th>SEAT</th><th>TITLE</th><th>NAME</th><th>TIER</th><th>MEAL</th></tr></thead><tbody>`;
            
            passengers.forEach(p => {
                const meals = p.meal ? p.meal.split(',').map(m => m.trim()) : [];
                const parentMeal = meals.find(m => m !== 'BBML') || '';
                const infantMeal = meals.find(m => m === 'BBML') || '';
                let mealDisplay = '';
                if (parentMeal && infantMeal) {
                    mealDisplay = `<strong>${parentMeal}</strong><span class="infant-meal">(+${infantMeal})</span>`;
                } else if (parentMeal) {
                    mealDisplay = `<strong>${parentMeal}</strong>`;
                } else if (infantMeal) {
                    mealDisplay = `<strong>${infantMeal}</strong>`;
                }
                
                html += `<tr>`;
                html += `<td style="border: 1px dashed #999; background: #fffacd;">&nbsp;</td>`;
                html += `<td>${p.title}</td><td>${p.name}</td><td><strong>${p.tier}</strong></td><td>${mealDisplay}</td>`;
                html += `</tr>`;
            });
            
            html += `</tbody></table>`;
            return html;
        }
        
        function getTierClass(tier) {
            if (tier === 'EMER') return 'seat-tier-emer';
            if (tier === 'PLAT') return 'seat-tier-plat';
            return '';
        }
        
        function hasSpecialRequirements(passenger) {
            return passenger.meal || passenger.tier === 'EMER' || passenger.tier === 'PLAT';
        }
        
        function formatMealDisplay(mealString) {
            if (!mealString) return '';
            const meals = mealString.split(',').map(m => m.trim());
            const parentMeal = meals.find(m => m !== 'BBML') || '';
            const infantMeal = meals.find(m => m === 'BBML') || '';
            
            let mealDisplay = '';
            if (parentMeal && infantMeal) {
                mealDisplay = `${parentMeal}:BBML`;
            } else if (parentMeal) {
                mealDisplay = parentMeal;
            } else if (infantMeal) {
                mealDisplay = infantMeal;
            }
            
            return mealDisplay;
        }
        
        function getBusinessClassPassengers(passengers, aircraftConfig) {
            const businessConfig = BUSINESS_CLASS_TEMPLATES[aircraftConfig];
            if (!businessConfig) return [];
            
            return passengers.filter(p => {
                if (p.class !== 'J' || !p.seat) return false;
                const seatNumber = p.seat.toUpperCase();
                const rowNum = parseInt(seatNumber.replace(/[A-Z]/g, ''));
                return businessConfig.businessRows.includes(rowNum);
            });
        }
        
        // =================== SEAT CHART FUNCTIONS ===================
        class SeatChartFlipper {
            static flipSeatChart(seatChartTable) {
                const rows = Array.from(seatChartTable.rows);
                const newTable = seatChartTable.cloneNode(false);
                
                if (rows.length > 0) {
                    const headerRow = rows[0].cloneNode(true);
                    const headerCells = Array.from(headerRow.cells);
                    headerRow.innerHTML = '';
                    
                    if (headerCells.length > 0) {
                        headerRow.appendChild(headerCells[0].cloneNode(true));
                    }
                    
                    const seatCells = headerCells.slice(1).reverse();
                    seatCells.forEach(cell => {
                        headerRow.appendChild(cell.cloneNode(true));
                    });
                    
                    newTable.appendChild(headerRow);
                }
                
                const bodyRows = rows.slice(1).reverse();
                bodyRows.forEach(row => {
                    const newRow = row.cloneNode(false);
                    const cells = Array.from(row.cells);
                    
                    if (cells.length > 0) {
                        newRow.appendChild(cells[0].cloneNode(true));
                    }
                    
                    const seatCells = cells.slice(1).reverse();
                    seatCells.forEach(cell => {
                        newRow.appendChild(cell.cloneNode(true));
                    });
                    
                    newTable.appendChild(newRow);
                });
                
                return newTable;
            }
        }
        
        function flipSeatChart(seatChartContainer) {
            const seatChartTable = seatChartContainer.querySelector('.seat-chart');
            if (!seatChartTable) return;
            const flippedTable = SeatChartFlipper.flipSeatChart(seatChartTable);
            seatChartContainer.replaceChild(flippedTable, seatChartTable);
            console.log('Seat chart flipped - rows and columns reversed!');
        }
        
        function flipAllSeatCharts() {
            const seatChartContainers = document.querySelectorAll('.seat-chart-container');
            let flipped = false;
            seatChartContainers.forEach(container => {
                if (container.querySelector('.seat-chart')) {
                    flipSeatChart(container);
                    flipped = true;
                }
            });
            return flipped;
        }
        
        function generateSeatChart(passengers, zone, aircraftConfig) {
            const seatMap = SEAT_MAPS[aircraftConfig];
            if (!seatMap) {
                return `<div class="error">Seat chart not available for selected aircraft configuration.</div>`;
            }
            
            const isBusinessZone = isBusinessClassZone(zone.name);
            const isNarrowbody = ['737NG', '737MAX', '737NR'].includes(aircraftConfig);
            
            let columns, aisles;
            if (isNarrowbody && isBusinessZone && seatMap.businessColumns) {
                columns = seatMap.businessColumns;
                aisles = [2];
            } else {
                columns = seatMap.columns;
                aisles = seatMap.aisles;
            }
            
            const startRow = zone.start;
            const endRow = zone.end;
            
            let tableClass = 'seat-chart';
            if (isNarrowbody) {
                tableClass += isBusinessZone ? ' narrowbody-business' : ' narrowbody-economy';
            } else {
                tableClass += ' widebody';
            }
            
            let html = `<div class="seat-chart-container">
                <table class="${tableClass}" data-font-size="${currentSettings.seatChartFontSize}">
                <thead><tr><th class="row-header">Row</th>`;
            
            columns.forEach(col => {
                if (col === '|') {
                    html += `<th class="aisle"></th>`;
                } else {
                    html += `<th>${col}</th>`;
                }
            });
            
            html += `</tr></thead><tbody>`;
            
            for (let row = startRow; row <= endRow; row++) {
                if (aircraftConfig === '333' && row === 3 && zone.name === 'B') {
                    continue;
                }
                
                const rowNum = row.toString().padStart(2, '0');
                const isZoneBoundary = row === zone.end;
                const rowClass = (row % 2 === 0) ? 'row-even' : 'row-odd';
                const additionalClasses = isZoneBoundary ? `zone-boundary ${rowClass}` : rowClass;
                
                html += `<tr class="${additionalClasses}"><td class="row-header">${rowNum}</td>`;
                
                const isA333BusinessRow = aircraftConfig === '333' && [1, 2, 4, 5, 6, 7].includes(row) && zone.name === 'B';
                const isExceptionRow = isA333BusinessRow && [2, 5, 7].includes(row);
                
                if (isA333BusinessRow && !isExceptionRow) {
                    // Handle A330-300 business class merged seats
                    let colIndex = 0;
                    while (colIndex < columns.length) {
                        const col = columns[colIndex];
                        
                        if (col === '|') {
                            html += `<td class="aisle"></td>`;
                            colIndex++;
                            continue;
                        }
                        
                        // Simplified merge logic for A333
                        const mergeGroups = [
                            { seats: ['A', 'C'], display: 'A', colSpan: 2 },
                            { seats: ['D', 'E'], display: 'D', colSpan: 2 },
                            { seats: ['F', 'G'], display: 'G', colSpan: 2 },
                            { seats: ['H', 'K'], display: 'K', colSpan: 2, exceptions: [2, 5, 7] }
                        ];
                        
                        let merged = false;
                        for (const group of mergeGroups) {
                            if (group.seats.includes(col)) {
                                if (group.exceptions && group.exceptions.includes(row)) {
                                    break;
                                }
                                
                                const seatNumber = `${rowNum}${group.display}`;
                                let passenger = null;
                                for (const seat of group.seats) {
                                    const testSeat = `${rowNum}${seat}`;
                                    passenger = passengers.find(p => p.seat === testSeat);
                                    if (passenger) break;
                                }
                                
                                let cellClass = 'seat-empty';
                                let tierClass = '';
                                
                                if (passenger) {
                                    cellClass = 'seat-occupied';
                                    tierClass = getTierClass(passenger.tier);
                                    if (currentSettings.showAllBusiness && isBusinessClassZone(zone.name) && !hasSpecialRequirements(passenger)) {
                                        cellClass = 'seat-business-regular';
                                    }
                                }
                                
                                html += `<td class="${cellClass} ${tierClass}" colspan="${group.colSpan}">`;
                                if (passenger) {
                                    const mealDisplay = formatMealDisplay(passenger.meal);
                                    const tierIcon = passenger.tier === 'PLAT' ? '‚ù§Ô∏è ' : (passenger.tier === 'EMER' ? 'üî¥ ' : '');
                                    
                                    if (isBusinessZone) {
                                        const businessName = truncateNameForBusinessClass(passenger.name);
                                        const nameParts = businessName.split('/');
                                        const firstName = nameParts[0] || '';
                                        const lastName = nameParts[1] || '';
                                        
                                        html += `<div class="seat-cell business-class">
                                            <div class="seat-line1">${tierIcon + passenger.title + '/' + firstName.toUpperCase()}</div>
                                            ${lastName ? `<div class="seat-line2">${lastName.toUpperCase()}</div>` : ''}
                                            <div class="seat-line3">${mealDisplay ? mealDisplay.toUpperCase() : '&nbsp;'}</div>
                                            <div class="seat-line4">&nbsp;</div>
                                        </div>`;
                                    } else {
                                        const namePart = passenger.title + '/' + passenger.name.split('/')[0];
                                        html += `<div class="seat-cell">
                                            <div class="seat-line1">${tierIcon + namePart.toUpperCase()}</div>
                                            ${mealDisplay ? `<div class="seat-line2">${mealDisplay.toUpperCase()}</div>` : ''}
                                        </div>`;
                                    }
                                } else {
                                    html += `<div class="seat-cell">${seatNumber}</div>`;
                                }
                                html += `</td>`;
                                
                                colIndex += group.colSpan;
                                merged = true;
                                break;
                            }
                        }
                        
                        if (!merged) {
                            const seatNumber = `${rowNum}${col}`;
                            const passenger = passengers.find(p => p.seat === seatNumber);
                            let cellClass = 'seat-empty';
                            let tierClass = '';
                            
                            if (passenger) {
                                cellClass = 'seat-occupied';
                                tierClass = getTierClass(passenger.tier);
                                if (currentSettings.showAllBusiness && isBusinessClassZone(zone.name) && !hasSpecialRequirements(passenger)) {
                                    cellClass = 'seat-business-regular';
                                }
                            }
                            
                            html += `<td class="${cellClass} ${tierClass}">`;
                            if (passenger) {
                                const mealDisplay = formatMealDisplay(passenger.meal);
                                const tierIcon = passenger.tier === 'PLAT' ? '‚ù§Ô∏è ' : (passenger.tier === 'EMER' ? 'üî¥ ' : '');
                                
                                if (isBusinessZone) {
                                    const businessName = truncateNameForBusinessClass(passenger.name);
                                    const nameParts = businessName.split('/');
                                    const firstName = nameParts[0] || '';
                                    const lastName = nameParts[1] || '';
                                    
                                    html += `<div class="seat-cell business-class">
                                        <div class="seat-line1">${tierIcon + passenger.title + '/' + firstName.toUpperCase()}</div>
                                        ${lastName ? `<div class="seat-line2">${lastName.toUpperCase()}</div>` : ''}
                                        <div class="seat-line3">${mealDisplay ? mealDisplay.toUpperCase() : '&nbsp;'}</div>
                                        <div class="seat-line4">&nbsp;</div>
                                    </div>`;
                                } else {
                                    const namePart = passenger.title + '/' + passenger.name.split('/')[0];
                                    html += `<div class="seat-cell">
                                        <div class="seat-line1">${tierIcon + namePart.toUpperCase()}</div>
                                        ${mealDisplay ? `<div class="seat-line2">${mealDisplay.toUpperCase()}</div>` : ''}
                                    </div>`;
                                }
                            } else {
                                html += `<div class="seat-cell">${seatNumber}</div>`;
                            }
                            html += `</td>`;
                            colIndex++;
                        }
                    }
                } else {
                    // Normal row generation
                    columns.forEach(col => {
                        if (col === '|') {
                            html += `<td class="aisle"></td>`;
                        } else {
                            const seatNumber = `${rowNum}${col}`;
                            const passenger = passengers.find(p => p.seat === seatNumber);
                            
                            let cellClass = 'seat-empty';
                            let tierClass = '';
                            
                            if (passenger) {
                                cellClass = 'seat-occupied';
                                tierClass = getTierClass(passenger.tier);
                                if (currentSettings.showAllBusiness && isBusinessClassZone(zone.name) && !hasSpecialRequirements(passenger)) {
                                    cellClass = 'seat-business-regular';
                                }
                            }
                            
                            html += `<td class="${cellClass} ${tierClass}">`;
                            if (passenger) {
                                const mealDisplay = formatMealDisplay(passenger.meal);
                                const tierIcon = passenger.tier === 'PLAT' ? '‚ù§Ô∏è ' : (passenger.tier === 'EMER' ? 'üî¥ ' : '');
                                
                                if (isBusinessZone) {
                                    const businessName = truncateNameForBusinessClass(passenger.name);
                                    const nameParts = businessName.split('/');
                                    const firstName = nameParts[0] || '';
                                    const lastName = nameParts[1] || '';
                                    
                                    html += `<div class="seat-cell business-class">
                                        <div class="seat-line1">${tierIcon + passenger.title + '/' + firstName.toUpperCase()}</div>
                                        ${lastName ? `<div class="seat-line2">${lastName.toUpperCase()}</div>` : ''}
                                        <div class="seat-line3">${mealDisplay ? mealDisplay.toUpperCase() : '&nbsp;'}</div>
                                        <div class="seat-line4">&nbsp;</div>
                                    </div>`;
                                } else {
                                    const namePart = passenger.title + '/' + passenger.name.split('/')[0];
                                    html += `<div class="seat-cell">
                                        <div class="seat-line1">${tierIcon + namePart.toUpperCase()}</div>
                                        ${mealDisplay ? `<div class="seat-line2">${mealDisplay.toUpperCase()}</div>` : ''}
                                    </div>`;
                                }
                            } else {
                                html += `<div class="seat-cell">${seatNumber}</div>`;
                            }
                            html += `</td>`;
                        }
                    });
                }
                
                html += `</tr>`;
            }
            
            html += `</tbody></table></div>`;
            return html;
        }
        
        // =================== BUSINESS CLASS SEAT CHART ===================
        function openBusinessClassSeatChart(aircraftType, passengers, flightInfo, zoneSummary) {
            const businessPassengers = getBusinessClassPassengers(passengers, aircraftType);
            if (businessPassengers.length === 0) {
                showError(`No business class passengers found for ${aircraftType}.`);
                return;
            }
            
            const businessZoneSummary = {
                totalPassengers: businessPassengers.length,
                specialMeals: businessPassengers.filter(p => p.meal).length,
                emerPlat: businessPassengers.filter(p => p.tier === 'EMER' || p.tier === 'PLAT').length,
                mealBreakdown: getMealBreakdown(businessPassengers),
                bbml: businessPassengers.filter(p => p.meal && p.meal.includes('BBML')).length
            };
            
            const businessChartData = {
                flightInfo: flightInfo,
                zoneSummary: businessZoneSummary,
                passengers: businessPassengers,
                config: {
                    aircraftType: aircraftType,
                    templateFile: BUSINESS_CLASS_TEMPLATES[aircraftType]?.template || 'sc-a333.html',
                    timestamp: Date.now(),
                    showAllBusiness: currentSettings.showAllBusiness
                }
            };
            
            const dataKey = 'business_chart_' + Date.now();
            localStorage.setItem(dataKey, JSON.stringify(businessChartData));
            cleanupLocalStorage('business_chart_', 5);
            
            const templateFile = BUSINESS_CLASS_TEMPLATES[aircraftType]?.template || 'sc-a333.html';
            const popupWindow = window.open(
                `${templateFile}?data=${dataKey}`, 
                '_blank',
                'width=1200,height=800,resizable=yes,scrollbars=yes,location=no,toolbar=no'
            );
            
            if (!popupWindow) {
                showError('Popup blocked! Please allow popups for this site.');
                return;
            }
            
            showSuccess(`Business class seat chart opened in new window with ${businessPassengers.length} passengers.`);
        }
        
        function getMealBreakdown(passengers) {
            const mealCounts = {};
            passengers.forEach(p => {
                if (p.meal) {
                    const meals = p.meal.split(',').map(m => m.trim());
                    meals.forEach(meal => {
                        if (meal !== 'BBML') {
                            mealCounts[meal] = (mealCounts[meal] || 0) + 1;
                        }
                    });
                }
            });
            
            return Object.entries(mealCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([meal, count]) => `${meal}: ${count}`)
                .join(', ');
        }
        
        function cleanupLocalStorage(prefix, keepCount) {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    keys.push({ key, timestamp: parseInt(key.split('_').pop()) });
                }
            }
            
            keys.sort((a, b) => a.timestamp - b.timestamp);
            for (let i = 0; i < keys.length - keepCount; i++) {
                localStorage.removeItem(keys[i].key);
            }
        }
        
        // =================== DUAL CHART SPECIFIC ===================
        function generateDualChart(passengers, flightInfo, aircraftType) {
            const chartData = {
                flightInfo: flightInfo,
                passengers: passengers,
                zoneSummary: generateZoneSummaryForDualChart(passengers),
                config: {
                    aircraftType: aircraftType,
                    timestamp: Date.now()
                }
            };
            
            if (!seatChartWindow || seatChartWindow.closed) {
                const timestamp = Date.now();
                const dataKey = `chartData_${timestamp}`;
                localStorage.setItem(dataKey, JSON.stringify(chartData));
                
                let popupFile = '';
                if (aircraftType === '737NG' || aircraftType === '737MAX') {
                    popupFile = 'sc-737.html';
                } else if (aircraftType === '737NR') {
                    popupFile = 'sc-737.html';
                }
                
                seatChartWindow = window.open(
                    `${popupFile}?data=${dataKey}&chart=top`,
                    'seatChart',
                    'width=1200,height=900,scrollbars=yes'
                );
                
                document.getElementById('manifestInput').value = '';
                showSuccess('First service chart opened! Clear and paste second manifest for second service.');
                
            } else if (chartReadyForSecondManifest) {
                const timestamp = Date.now();
                const dataKey = `chartData_bottom_${timestamp}`;
                localStorage.setItem(dataKey, JSON.stringify(chartData));
                
                seatChartWindow.postMessage({
                    type: 'loadBottomChart',
                    dataKey: dataKey
                }, '*');
                
                document.getElementById('manifestInput').value = '';
                chartReadyForSecondManifest = false;
                showSuccess('Second service sent to existing chart window!');
            } else {
                showError('First chart is still loading. Please wait a moment and try again.');
            }
        }
        
        function generateZoneSummaryForDualChart(passengers) {
            const totalPassengers = passengers.length;
            const specialMeals = passengers.filter(p => p.meal).length;
            const emerPlat = passengers.filter(p => p.tier === 'EMER' || p.tier === 'PLAT').length;
            
            const mealCounts = {};
            passengers.forEach(p => {
                if (p.meal) {
                    const meals = p.meal.split(',').map(m => m.trim());
                    meals.forEach(meal => {
                        if (meal !== 'BBML') {
                            mealCounts[meal] = (mealCounts[meal] || 0) + 1;
                        }
                    });
                }
            });
            
            const mealBreakdown = Object.entries(mealCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([meal, count]) => `${meal}: ${count}`)
                .join(', ');
            
            const bbml = passengers.filter(p => p.meal && p.meal.includes('BBML')).length;
            
            return {
                totalPassengers: totalPassengers,
                specialMeals: specialMeals,
                emerPlat: emerPlat,
                mealBreakdown: mealBreakdown,
                bbml: bbml
            };
        }
        
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'chartReady') {
                chartReadyForSecondManifest = true;
                showSuccess('First chart loaded successfully. You can now paste the second manifest for the second service.');
            }
        });
        
        // =================== UI FUNCTIONS ===================
        function clearAll() {
            document.getElementById('manifestInput').value = '';
            document.getElementById('reportContent').innerHTML = '';
        }
        
        function downloadPage() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bpm-pro.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSuccess('‚úì Offline version downloaded as bpm-pro.html');
        }
        
        function toggleSettings() {
            const settings = document.getElementById('advancedSettings');
            const button = document.getElementById('toggleAdvanced');
            settings.classList.toggle('open');
            button.textContent = settings.classList.contains('open') ? '‚ñ≤ Advanced Settings' : '‚ñº Advanced Settings';
        }
        
        // =================== IFRAME MANAGEMENT ===================
        function reloadIframe() {
            const iframe = document.getElementById('tutorialIframe');
            iframe.src = iframe.src;
            tutorialIframeLoaded = false;
            showIframeLoading();
            showSuccess('Tutorial reloaded');
        }
        
        function openTutorialInNewTab() {
            window.open('tutorial.html', '_blank');
        }
        
        function showIframeLoading() {
            const loadingDiv = document.getElementById('iframe-loading');
            if (loadingDiv) loadingDiv.style.display = 'flex';
        }
        
        function hideIframeLoading() {
            const loadingDiv = document.getElementById('iframe-loading');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
                tutorialIframeLoaded = true;
            }
        }
        
        function reloadVersionIframe() {
            const iframe = document.getElementById('versionIframe');
            iframe.src = iframe.src;
            versionIframeLoaded = false;
            showVersionIframeLoading();
            showSuccess('Version history reloaded');
        }
        
        function openVersionsInNewTab() {
            window.open('versions.html', '_blank');
        }
        
        function showVersionIframeLoading() {
            const loadingDiv = document.getElementById('iframe-loading-version');
            if (loadingDiv) loadingDiv.style.display = 'flex';
        }
        
        function hideVersionIframeLoading() {
            const loadingDiv = document.getElementById('iframe-loading-version');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
                versionIframeLoaded = true;
            }
        }
        
        function toggleHelp(type) {
            const tutorial = document.getElementById('tutorialContent');
            const version = document.getElementById('versionContent');
            const tutorialLabel = document.getElementById('tutorialLabel');
            const versionLabel = document.getElementById('versionLabel');
            
            if (type === 'tutorial') {
                const isChecked = document.getElementById('toggleTutorial').checked;
                tutorial.style.display = isChecked ? 'block' : 'none';
                tutorialLabel.textContent = isChecked ? 'Hide' : 'Show';
                
                if (isChecked) {
                    if (!tutorialIframeLoaded) showIframeLoading();
                    document.getElementById('toggleVersion').checked = false;
                    version.style.display = 'none';
                    versionLabel.textContent = 'Show';
                }
            } else {
                const isChecked = document.getElementById('toggleVersion').checked;
                version.style.display = isChecked ? 'block' : 'none';
                versionLabel.textContent = isChecked ? 'Hide' : 'Show';
                
                if (isChecked) {
                    if (!versionIframeLoaded) showVersionIframeLoading();
                    document.getElementById('toggleTutorial').checked = false;
                    tutorial.style.display = 'none';
                    tutorialLabel.textContent = 'Show';
                }
            }
        }
        
        // =================== INITIALIZATION ===================
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved lists
            loadSavedLists();
            
            // Initialize zone checkboxes and UI
            updateZoneCheckboxes();
            updateUIFromSettings();
            
            // Initialize dual chart mode
            const layoutValue = document.getElementById('layoutStyle').value;
            if (layoutValue === 'dual-chart-737') {
                isDualChartMode = true;
                document.getElementById('dualChartToggle').checked = true;
                document.getElementById('dualChartLabel').textContent = 'Dual Chart Mode ON';
                document.getElementById('dualChartIndicator').classList.add('active');
                showDualChartInstructions();
            }
            
            // Layout style change listener
            document.getElementById('layoutStyle').addEventListener('change', function() {
                const layoutValue = this.value;
                if (layoutValue === 'dual-chart-737') {
                    isDualChartMode = true;
                    document.getElementById('dualChartToggle').checked = true;
                    document.getElementById('dualChartLabel').textContent = 'Dual Chart Mode ON';
                    document.getElementById('dualChartIndicator').classList.add('active');
                    showDualChartInstructions();
                } else {
                    isDualChartMode = false;
                    document.getElementById('dualChartToggle').checked = false;
                    document.getElementById('dualChartLabel').textContent = 'Dual Chart Mode';
                    document.getElementById('dualChartIndicator').classList.remove('active');
                    hideDualChartInstructions();
                }
            });
            
            // Live preview for controls
            const controls = [
                'aircraftType', 'layoutStyle', 'fontSizeSlider', 'tableWidthSlider',
                'seatChartFontSlider', 'compactPrintMode', 'landscapeMode', 
                'pageBreakBetweenZones', 'avoidOrphanRows', 'flipSeatChart', 'showAllBusiness',
                'showUnassignedInPrint'
            ];
            
            controls.forEach(controlId => {
                const control = document.getElementById(controlId);
                if (control) {
                    control.addEventListener('change', debounce(() => {
                        updateSettingsFromControls();
                        if (hasValidManifest()) {
                            generateReportWithCurrentSettings();
                        }
                    }, 300));
                }
            });
            
            // Auto-detection preview
            const manifestInput = document.getElementById('manifestInput');
            manifestInput.addEventListener('input', debounce(() => {
                if (manifestInput.value.trim()) {
                    showAutoDetectionIndicator();
                }
            }, 500));
            
            function showAutoDetectionIndicator() {
                const input = document.getElementById('manifestInput').value;
                if (!input.trim()) return;
                
                try {
                    const { flightInfo, passengers } = parseManifest(input);
                    const detectedType = detectAircraftType(passengers, flightInfo);
                    const effectiveAircraftConfig = getEffectiveAircraftConfig(detectedType, flightInfo, passengers);
                    const effectiveLayout = getEffectiveLayout(detectedType);
                    
                    const pageEstimate = document.getElementById('pageEstimate');
                    if (pageEstimate) {
                        const aircraftType = document.getElementById('aircraftType').value;
                        const layoutStyle = document.getElementById('layoutStyle').value;
                        
                        let detectionInfo = '';
                        if (aircraftType === 'auto') {
                            detectionInfo += `<div><strong>Aircraft:</strong> <span style="color: #059669;">${effectiveAircraftConfig}</span> (Auto-detected)</div>`;
                        }
                        if (layoutStyle === 'auto') {
                            const layoutName = effectiveLayout === 'port-starboard' ? 'Port/Starboard' : 'Single Column';
                            detectionInfo += `<div><strong>Layout:</strong> <span style="color: #059669;">${layoutName}</span> (Auto)</div>`;
                        }
                        
                        if (detectionInfo) {
                            pageEstimate.innerHTML = `<div style="margin-bottom: 5px;"><strong>üìä Auto-detection Preview:</strong></div>${detectionInfo}`;
                        }
                    }
                } catch (error) {
                    console.log("Auto-detection preview error:", error);
                }
            }
            
            // Print color fix
            function printWithColors() {
                const beforePrint = () => {
                    document.body.style.webkitPrintColorAdjust = 'exact';
                    document.body.style.printColorAdjust = 'exact';
                };
                
                const afterPrint = () => {
                    document.body.style.webkitPrintColorAdjust = '';
                    document.body.style.printColorAdjust = '';
                };
                
                if (window.matchMedia) {
                    const mediaQueryList = window.matchMedia('print');
                    mediaQueryList.addListener((mql) => {
                        if (mql.matches) beforePrint();
                        else afterPrint();
                    });
                }
                
                const printButtons = document.querySelectorAll('[onclick*="window.print()"]');
                printButtons.forEach(btn => {
                    btn.onclick = (e) => {
                        e.preventDefault();
                        beforePrint();
                        setTimeout(() => {
                            window.print();
                            setTimeout(afterPrint, 100);
                        }, 100);
                    };
                });
            }
            
            printWithColors();
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    const textarea = document.getElementById('manifestInput');
                    if (textarea.value.trim()) {
                        e.preventDefault();
                        generateQuickReport();
                    }
                }
                
                // Ctrl+S to save current list
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveCurrentList();
                }
            });
        });
    </script>
    <script src="https://gnrcounter.com/counter.php?accId=5a888a8c18748f69460d5c4fc6b40d8f"></script>
</body>
</html>